# -*- coding: utf-8 -*-
"""
퓨어웰 음료 AI Agent - 프롬프트 라우터
간단한 질문 → 확장 프롬프트 생성
"""

from dataclasses import dataclass
from typing import Optional
import re


@dataclass
class ChartConfig:
    """차트 설정"""
    chart_type: str  # bar, line, pie, gauge
    style: str       # 스타일 설명
    title: str       # 차트 제목


@dataclass
class PromptRoute:
    """프롬프트 라우팅 결과"""
    keywords: list[str]          # 매칭된 키워드
    chart_config: ChartConfig    # 차트 설정
    data_source: str             # 데이터 소스 설명
    expanded_prompt: str         # 확장된 프롬프트


# ============================================
# 프롬프트 템플릿 정의
# ============================================

PROMPT_TEMPLATES = {
    # ==================== BAR 차트 ====================
    "라인별_생산량": {
        "keywords": ["라인별", "생산량", "라인", "생산현황"],
        "chart": ChartConfig("bar", "그라데이션 + 둥근 모서리", "라인별 생산량 현황"),
        "data_source": "mes_work_order + operation_exec (라인별 qty_output 합계)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 라인별 생산량 분석
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 라인별 금일 생산량 집계
SELECT
    l.line_id,
    l.line_name,
    l.line_type,
    COUNT(DISTINCT o.op_exec_id) as work_count,
    SUM(o.qty_output) as total_output,
    SUM(o.scrap_qty) as total_scrap,
    ROUND(SUM(o.scrap_qty) * 100.0 / NULLIF(SUM(o.qty_input), 0), 2) as scrap_rate
FROM operation_exec o
JOIN mes_work_order m ON o.mes_order_id = m.mes_order_id
JOIN line_mst l ON m.line_id = l.line_id
WHERE DATE(o.end_dt) = DATE('now')
  AND o.result_flag = 'PASS'
GROUP BY l.line_id, l.line_name, l.line_type
ORDER BY l.line_id;

-- 라인별 비가동 시간 조회 (연관 분석용)
SELECT
    l.line_name,
    SUM(d.duration_min) as total_downtime_min,
    r.description as main_reason
FROM downtime_event d
JOIN line_mst l ON d.line_id = l.line_id
LEFT JOIN reason_code_mst r ON d.reason_code = r.reason_code
WHERE DATE(d.start_dt) = DATE('now')
GROUP BY l.line_id
ORDER BY total_downtime_min DESC;
----------------------------------------------------------

[2. 조회 대상 라인 정보]
----------------------------------------------------------
| 라인ID | 라인명 | 용도 | 일일 목표 | 최대 생산능력 |
|--------|--------|------|-----------|---------------|
| L01 | 1라인 | 기능성 유산균·발효 음료 전용 | 15,000병 | 20,000병 |
| L02 | 2라인 | 과채·허브 기반 건강음료 | 20,000병 | 25,000병 |
| L03 | 3라인 | 단백질·식이섬유 기반 음료 | 18,000병 | 22,000병 |
| PILOT | Pilot | 신제품 소량 생산/배합 테스트 | 3,000병 | 5,000병 |

* 일일 총 목표: 56,000병
* 공장 최대 생산능력: 80,000병/일
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[달성률 기준]
- 95% 이상: ✅ 정상 (GREEN)
- 80% ~ 95%: ⚠️ 주의 (YELLOW) - 원인 분석 필요
- 80% 미만: 🚨 경고 (RED) - 즉시 조치 필요

[불량률 기준]
- 2% 이하: ✅ 정상
- 2% ~ 3%: ⚠️ 주의
- 3% 초과: 🚨 경고

[비가동 시간 기준]
- 30분 이하: ✅ 정상
- 30분 ~ 60분: ⚠️ 주의
- 60분 초과: 🚨 경고 - 설비팀 점검 필요
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
생산량 이상 감지 시 자동으로 다음을 추가 조회합니다:

1) 달성률 80% 미만 라인 발견 시:
   → downtime_event 테이블에서 해당 라인 비가동 내역 조회
   → reason_code_mst와 JOIN하여 비가동 사유 분석

2) 불량률 3% 초과 라인 발견 시:
   → operation_param_log에서 공정 파라미터 이상 확인
   → ccp_check_log에서 CCP 이탈 여부 확인

3) 특정 라인만 저조할 경우:
   → equipment_mst에서 해당 라인 설비 상태 확인
   → alarm_event에서 알람 발생 이력 확인
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
현재 라인별 생산 현황을 확인했습니다. (2024-01-15 16:30 기준)

📊 [생산 데이터 조회]
┌────────┬──────────┬──────────┬─────────┬────────┐
│ 라인   │ 생산량   │ 목표     │ 달성률  │ 상태   │
├────────┼──────────┼──────────┼─────────┼────────┤
│ 1라인  │ 12,450병 │ 15,000병 │ 83.0%   │ ⚠️ 주의 │
│ 2라인  │ 19,230병 │ 20,000병 │ 96.2%   │ ✅ 정상 │
│ 3라인  │ 17,890병 │ 18,000병 │ 99.4%   │ ✅ 정상 │
│ Pilot  │ 2,850병  │ 3,000병  │ 95.0%   │ ✅ 정상 │
├────────┼──────────┼──────────┼─────────┼────────┤
│ 합계   │ 52,420병 │ 56,000병 │ 93.6%   │ ⚠️ 주의 │
└────────┴──────────┴──────────┴─────────┴────────┘

🔍 [자동 분석 결과]
⚠️ 1라인 생산량이 목표 대비 83.0% 수준입니다.

[원인 분석 - 비가동 내역 자동 조회]
• 14:00~16:00 설비점검(PM) 발생 - 120분
• 비가동 사유: 정기 예방보전 (계획정지)
• 예상 손실 생산량: 약 2,500병

[연관 지표 확인]
• 1라인 불량률: 1.8% (정상 범위)
• 1라인 CCP 합격률: 100% (정상)
• 원료 투입 대비 산출 정합성: 98.2% (정상)

💡 [권장사항]
1. PM 일정을 야간 또는 주말로 조정 검토 (생산 영향 최소화)
2. 내일 1라인 추가 30분 연장 운영으로 목표 보완 가능
3. 주간 PM 일정 사전 공유하여 생산계획 반영 필요

📈 [전일 대비]
• 총 생산량: 52,420병 (전일 대비 -3.2%)
• 1라인: -17.0% ↓ (PM 영향)
• 2라인: +2.1% ↑
• 3라인: +0.5% ↑
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chart_type": "bar",
  "style": "gradient_rounded",
  "title": "라인별 생산량 현황",
  "subtitle": "2024-01-15 16:30 기준",
  "data": [
    {
      "name": "1라인",
      "value": 12450,
      "target": 15000,
      "achievement_rate": 83.0,
      "status": "warning",
      "color": "#FFA500"
    },
    {
      "name": "2라인",
      "value": 19230,
      "target": 20000,
      "achievement_rate": 96.2,
      "status": "normal",
      "color": "#4CAF50"
    },
    {
      "name": "3라인",
      "value": 17890,
      "target": 18000,
      "achievement_rate": 99.4,
      "status": "normal",
      "color": "#4CAF50"
    },
    {
      "name": "Pilot",
      "value": 2850,
      "target": 3000,
      "achievement_rate": 95.0,
      "status": "normal",
      "color": "#4CAF50"
    }
  ],
  "threshold": {
    "danger": 80,
    "warning": 95,
    "normal": 100
  },
  "annotations": [
    {
      "line": "1라인",
      "type": "warning",
      "message": "PM으로 인한 생산 차질"
    }
  ]
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. 반드시 위 SQL을 실행하여 실제 데이터 기반으로 응답할 것
2. 모든 수치는 천 단위 콤마 표시 (예: 12,450병)
3. 달성률은 소수점 1자리까지 표시
4. 이상 징후 발견 시 반드시 원인 분석 포함
5. 권장사항은 구체적이고 실행 가능한 내용으로 제시
6. 차트 JSON은 프론트엔드 렌더링용으로 정확한 형식 유지
7. 전일/전주 대비 증감은 화살표(↑↓)로 직관적 표시
==============================================================
"""
    },

    "월별_매출": {
        "keywords": ["월별", "매출", "매출현황", "매출액"],
        "chart": ChartConfig("bar", "그라데이션 + 둥근 모서리", "월별 매출 현황"),
        "data_source": "sales_order + sales_order_dtl (월별 금액 합계)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 월별 매출 현황 분석
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 월별 매출 집계 (수주 기준)
SELECT
    strftime('%Y-%m', s.so_date) as sales_month,
    COUNT(DISTINCT s.so_no) as order_count,
    SUM(d.order_qty * d.unit_price) as total_sales,
    COUNT(DISTINCT s.customer_id) as customer_count
FROM sales_order s
JOIN sales_order_dtl d ON s.so_no = d.so_no
WHERE s.so_date >= date('now', '-6 months')
  AND s.status IN ('OPEN', 'CLOSED')
GROUP BY strftime('%Y-%m', s.so_date)
ORDER BY sales_month DESC;

-- 고객 유형별 매출 분석 (연관 분석용)
SELECT
    c.biz_type,
    SUM(d.order_qty * d.unit_price) as type_sales,
    ROUND(SUM(d.order_qty * d.unit_price) * 100.0 /
          (SELECT SUM(d2.order_qty * d2.unit_price)
           FROM sales_order_dtl d2
           JOIN sales_order s2 ON d2.so_no = s2.so_no
           WHERE s2.so_date >= date('now', '-1 month')), 1) as sales_ratio
FROM sales_order s
JOIN sales_order_dtl d ON s.so_no = d.so_no
JOIN customer_mst c ON s.customer_id = c.customer_id
WHERE s.so_date >= date('now', '-1 month')
GROUP BY c.biz_type
ORDER BY type_sales DESC;
----------------------------------------------------------

[2. 퓨어웰 재무 현황 기준]
----------------------------------------------------------
| 구분 | 2022년 | 2023년 | 2024년 | 비고 |
|------|--------|--------|--------|------|
| 매출액 | 278억 | 326억 | 394억 | 연 20% 성장 |
| 영업이익 | 17.5억 | 19.3억 | 25.7억 | |
| 영업이익률 | 6.2% | 5.9% | 6.5% | |

[사업군별 매출 비중]
- OEM 제조: 56% (이커머스 D2C, 홈쇼핑 PB)
- 배합서비스: 24% (기능성 원료 배합)
- ODM 개발: 20% (맞춤형 제품 개발)

[월별 매출 목표]
- 월 평균 목표: 32.8억원 (연 394억 ÷ 12)
- 성수기(여름): 38억원 / 비수기(겨울): 28억원
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[매출 달성률 기준]
- 100% 이상: ✅ 초과달성 (GREEN)
- 90% ~ 100%: ✅ 정상 (GREEN)
- 80% ~ 90%: ⚠️ 주의 (YELLOW) - 영업 강화 필요
- 80% 미만: 🚨 경고 (RED) - 긴급 대응 필요

[성장률 기준]
- 전월 대비 +10% 이상: 🔥 고성장
- 전월 대비 +0~10%: ✅ 안정 성장
- 전월 대비 -10~0%: ⚠️ 소폭 하락
- 전월 대비 -10% 이하: 🚨 급락 주의

[고객 집중도 기준]
- Top 1 고객 비중 30% 초과: ⚠️ 의존도 주의
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
매출 이상 감지 시 자동으로 다음을 추가 조회합니다:

1) 매출 급락 시:
   → customer_mst와 JOIN하여 이탈 고객 분석
   → 품목별 매출 변화 확인 (item_mst)

2) 특정 고객사 매출 급증 시:
   → 해당 고객 주문 패턴 분석
   → 생산 캐파 대응 가능 여부 확인

3) 사업군별 비중 변화 시:
   → OEM/ODM/배합서비스 비중 변화 트렌드
   → 수익성 높은 사업군 집중도 분석
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
월별 매출 현황을 분석했습니다. (2024년 1월~6월)

💰 [매출 데이터 조회]
┌─────────┬──────────┬─────────┬──────────┬─────────┐
│ 월      │ 매출액   │ 목표    │ 달성률   │ 전월비  │
├─────────┼──────────┼─────────┼──────────┼─────────┤
│ 2024-06 │ 35.2억   │ 38.0억  │ 92.6%    │ +8.3% ↑ │
│ 2024-05 │ 32.5억   │ 32.8억  │ 99.1%    │ +5.2% ↑ │
│ 2024-04 │ 30.9억   │ 32.8억  │ 94.2%    │ -2.1% ↓ │
│ 2024-03 │ 31.6억   │ 32.8억  │ 96.3%    │ +12.1% ↑│
│ 2024-02 │ 28.2억   │ 28.0억  │ 100.7%   │ -5.4% ↓ │
│ 2024-01 │ 29.8억   │ 28.0억  │ 106.4%   │ -      │
├─────────┼──────────┼─────────┼──────────┼─────────┤
│ 상반기  │ 188.2억  │ 193.2억 │ 97.4%    │ -      │
└─────────┴──────────┴─────────┴──────────┴─────────┘

📊 [사업군별 분석]
• OEM 제조: 105.4억 (56.0%) - 목표 대비 98%
• 배합서비스: 45.2억 (24.0%) - 목표 대비 102%
• ODM 개발: 37.6억 (20.0%) - 목표 대비 94%

🏢 [주요 고객사 TOP 5]
1. ○○홈쇼핑 PB: 28.5억 (15.1%)
2. △△ D2C 브랜드: 22.3억 (11.9%)
3. 일본 OEM A社: 18.7억 (9.9%)
4. □□ 건강브랜드: 15.2억 (8.1%)
5. ◇◇ 스타트업: 12.8억 (6.8%)

🔍 [자동 분석 결과]
✅ 상반기 매출 목표 달성률 97.4%로 양호한 수준입니다.
⚠️ 6월 성수기 목표(38억) 대비 92.6%로 소폭 미달

[원인 분석]
• 홈쇼핑 PB 주문 지연 (예상 대비 -1.5억)
• ODM 신규 프로젝트 2건 7월로 이연

💡 [권장사항]
1. 홈쇼핑 PB 추가 주문 협의 (7월 초 미팅 제안)
2. 하반기 성수기(7~8월) 프로모션 제품 선제안
3. 일본 수출 확대 검토 (현재 9.9% → 목표 15%)
4. ODM 개발 리드타임 단축으로 매출 인식 앞당기기
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chart_type": "bar",
  "style": "gradient_rounded",
  "title": "월별 매출 현황",
  "subtitle": "2024년 상반기 (단위: 억원)",
  "data": [
    {"name": "1월", "value": 29.8, "target": 28.0, "growth": null, "status": "excellent"},
    {"name": "2월", "value": 28.2, "target": 28.0, "growth": -5.4, "status": "normal"},
    {"name": "3월", "value": 31.6, "target": 32.8, "growth": 12.1, "status": "normal"},
    {"name": "4월", "value": 30.9, "target": 32.8, "growth": -2.1, "status": "warning"},
    {"name": "5월", "value": 32.5, "target": 32.8, "growth": 5.2, "status": "normal"},
    {"name": "6월", "value": 35.2, "target": 38.0, "growth": 8.3, "status": "warning"}
  ],
  "target_line": {
    "normal": 32.8,
    "peak_season": 38.0,
    "off_season": 28.0
  },
  "summary": {
    "total": 188.2,
    "target": 193.2,
    "achievement_rate": 97.4
  }
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. 매출 금액은 억원 단위로 소수점 1자리까지 표시
2. 달성률, 성장률은 % 단위로 소수점 1자리까지 표시
3. 전월 대비 증감은 화살표(↑↓)로 직관적 표시
4. 사업군별 비중은 반드시 포함 (OEM/배합/ODM)
5. Top 5 고객사는 금액과 비중 함께 표시
6. 경영진 보고용이므로 핵심 인사이트 우선 제시
7. 구체적인 액션 플랜 제안 필수
==============================================================
"""
    },

    "설비별_비가동": {
        "keywords": ["설비별", "비가동", "비가동시간", "다운타임", "설비", "고장"],
        "chart": ChartConfig("bar", "그라데이션 + 둥근 모서리", "설비별 비가동 시간 분석"),
        "data_source": "downtime_event + equipment_mst + reason_code_mst",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 설비별 비가동 시간 분석
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 설비별 비가동 시간 집계
SELECT
    e.equip_id,
    e.equip_name,
    e.equip_type,
    l.line_name,
    COUNT(d.downtime_id) as event_count,
    SUM(d.duration_min) as total_downtime_min,
    ROUND(SUM(d.duration_min) / 60.0, 1) as total_downtime_hr
FROM downtime_event d
JOIN equipment_mst e ON d.equip_id = e.equip_id
JOIN line_mst l ON e.line_id = l.line_id
WHERE DATE(d.start_dt) = DATE('now')
GROUP BY e.equip_id, e.equip_name, e.equip_type, l.line_name
ORDER BY total_downtime_min DESC;

-- 비가동 사유별 분석 (계획 vs 비계획)
SELECT
    r.reason_type,  -- PLANNED(계획), UNPLANNED(비계획)
    r.reason_code,
    r.description,
    COUNT(*) as event_count,
    SUM(d.duration_min) as total_min,
    ROUND(AVG(d.duration_min), 1) as avg_min
FROM downtime_event d
JOIN reason_code_mst r ON d.reason_code = r.reason_code
WHERE DATE(d.start_dt) = DATE('now')
GROUP BY r.reason_type, r.reason_code, r.description
ORDER BY total_min DESC;

-- 설비별 고장 빈도 (최근 7일)
SELECT
    e.equip_name,
    COUNT(*) as failure_count,
    SUM(d.duration_min) as total_downtime,
    ROUND(AVG(d.duration_min), 0) as avg_repair_time
FROM downtime_event d
JOIN equipment_mst e ON d.equip_id = e.equip_id
JOIN reason_code_mst r ON d.reason_code = r.reason_code
WHERE d.start_dt >= date('now', '-7 days')
  AND r.reason_type = 'UNPLANNED'
GROUP BY e.equip_id, e.equip_name
HAVING failure_count >= 2
ORDER BY failure_count DESC;
----------------------------------------------------------

[2. 설비 마스터 정보]
----------------------------------------------------------
| 설비유형 | 설비명 | 수량 | 사양 | 예방보전주기 |
|----------|--------|------|------|--------------|
| 배합탱크 | MIX-3T-01~04 | 4기 | 3톤, 교반기 | 주 1회 청소 |
| 배합탱크 | MIX-5T-01~04 | 4기 | 5톤, 교반기+자켓 | 주 1회 청소 |
| 배합탱크 | MIX-10T-01~04 | 4기 | 10톤, 풀자켓 | 주 1회 청소 |
| 살균기 | UHT-01~03 | 3기 | 85~95℃, 판형 | 월 1회 CIP |
| 충진기 | FILL-01~03 | 3기 | 200mL~1L, 32헤드 | 주 1회 점검 |
| 금속검출기 | MD-01~03 | 3기 | Fe 1.0mm, SUS 1.5mm | 일 2회 검증 |
| 라벨러 | LBL-01~03 | 3기 | 200~500 BPM | 주 1회 점검 |

* 총 설비: 24기
* 일일 계획 가동시간: 16시간 (2교대)
* 목표 가용률: 90% 이상
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[일일 비가동 시간 기준 - 설비별]
- 30분 이하: ✅ 정상 (GREEN) - 일상적 수준
- 30분 ~ 60분: ⚠️ 주의 (YELLOW) - 원인 분석 필요
- 60분 초과: 🚨 경고 (RED) - 즉시 설비팀 점검

[비가동 유형별 기준]
- 계획정지(PM/청소): 총 60분 이내 → 정상
- 비계획정지(고장): 총 30분 이내 → 정상
- 품질대기(자재/승인): 총 30분 이내 → 정상

[반복 고장 기준 - 주간]
- 동일 설비 고장 2회 이상: ⚠️ 점검 필요
- 동일 설비 고장 3회 이상: 🚨 정밀 진단 필요

[OEE 영향도 산출]
- 가용률 손실 = 비가동시간 / 계획가동시간 × 100
- 라인 가용률 목표: 92% 이상
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
비가동 이상 감지 시 자동으로 다음을 추가 조회합니다:

1) 특정 설비 비가동 60분 초과 시:
   → alarm_event에서 해당 설비 알람 이력 조회
   → equipment_mst에서 최근 PM 이력 확인
   → 수리 이력 및 교체 부품 조회

2) 비계획정지 비율이 40% 초과 시:
   → 최근 7일간 고장 패턴 분석
   → 반복 고장 설비 리스트 추출
   → 예방보전 일정 vs 실제 고장 비교

3) 특정 라인 가용률 90% 미만 시:
   → 해당 라인 전체 설비 비가동 내역 조회
   → operation_exec에서 생산 손실량 산출
   → 병목 설비 식별
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
설비별 비가동 현황을 분석했습니다. (2024-01-15 16:30 기준)

🔧 [비가동 시간 현황]
┌───────────────┬────────┬──────────┬──────────┬─────────┐
│ 설비          │ 라인   │ 횟수     │ 비가동   │ 상태    │
├───────────────┼────────┼──────────┼──────────┼─────────┤
│ UHT-02        │ 2라인  │ 3회      │ 95분     │ 🚨 경고 │
│ FILL-01       │ 1라인  │ 2회      │ 45분     │ ⚠️ 주의 │
│ MIX-10T-03    │ 3라인  │ 1회      │ 30분     │ ✅ 정상 │
│ MD-01         │ 1라인  │ 1회      │ 15분     │ ✅ 정상 │
│ LBL-02        │ 2라인  │ 1회      │ 10분     │ ✅ 정상 │
├───────────────┼────────┼──────────┼──────────┼─────────┤
│ 합계          │ -      │ 8회      │ 195분    │ -       │
└───────────────┴────────┴──────────┴──────────┴─────────┘

📊 [비가동 사유 분석]
┌────────────────┬────────┬──────────┬──────────┐
│ 구분           │ 유형   │ 건수     │ 시간(분) │
├────────────────┼────────┼──────────┼──────────┤
│ 설비고장       │ 비계획 │ 4회      │ 125분    │
│ 예방보전(PM)   │ 계획   │ 2회      │ 45분     │
│ 자재대기       │ 기타   │ 2회      │ 25분     │
└────────────────┴────────┴──────────┴──────────┘

🔍 [자동 분석 결과]
🚨 UHT-02 살균기 비정상 비가동 감지!

[상세 내역]
• 09:15~10:20 (65분) - 온도센서 이상 → 교체 완료
• 13:40~14:00 (20분) - 배관 압력 이상 → 밸브 조정
• 15:30~15:40 (10분) - 알람 발생 → 리셋

[알람 이력 조회 결과]
• 오늘 UHT-02 알람 5건 발생
• 주요 알람: TEMP_HIGH (2), PRESSURE_LOW (3)

[예방보전 이력 확인]
• 최근 PM: 2024-01-08 (7일 전)
• 다음 PM 예정: 2024-01-22

⚠️ FILL-01 충진기 - 주간 고장 2회 발생
• 이번 주 누적: 3회 고장, 총 120분 비가동
• 주요 원인: 노즐 막힘 (60%), 센서 오동작 (40%)

💡 [권장 조치사항]
1. [긴급] UHT-02 정밀 진단 요청
   - 온도센서 캘리브레이션 확인
   - 배관 밸브 상태 점검
   - 다음 PM 시 압력게이지 교체 검토

2. [이번 주] FILL-01 예방점검 실시
   - 노즐 분해 청소 (32개)
   - 근접센서 위치 재조정
   - 필터 교체 권장

3. [개선제안] 2라인 설비 노후화 검토
   - UHT-02, FILL-02 모두 가동 5년차
   - 연간 교체 계획 수립 필요

📈 [OEE 영향도]
• 금일 계획가동시간: 960분 (16시간)
• 비가동 손실: 195분
• 가용률: 79.7% (목표 92% 대비 ↓12.3%p)
• 추정 생산손실: 약 3,200병
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chart_type": "bar",
  "style": "gradient_rounded",
  "title": "설비별 비가동 시간 현황",
  "subtitle": "2024-01-15 기준 (단위: 분)",
  "orientation": "horizontal",
  "data": [
    {
      "name": "UHT-02",
      "value": 95,
      "line": "2라인",
      "event_count": 3,
      "reason_type": "UNPLANNED",
      "status": "critical",
      "color": "#E53935"
    },
    {
      "name": "FILL-01",
      "value": 45,
      "line": "1라인",
      "event_count": 2,
      "reason_type": "UNPLANNED",
      "status": "warning",
      "color": "#FFA500"
    },
    {
      "name": "MIX-10T-03",
      "value": 30,
      "line": "3라인",
      "event_count": 1,
      "reason_type": "PLANNED",
      "status": "normal",
      "color": "#4CAF50"
    },
    {
      "name": "MD-01",
      "value": 15,
      "line": "1라인",
      "event_count": 1,
      "reason_type": "UNPLANNED",
      "status": "normal",
      "color": "#4CAF50"
    },
    {
      "name": "LBL-02",
      "value": 10,
      "line": "2라인",
      "event_count": 1,
      "reason_type": "PLANNED",
      "status": "normal",
      "color": "#4CAF50"
    }
  ],
  "threshold_lines": [
    {"value": 30, "label": "주의 기준", "color": "#FFA500"},
    {"value": 60, "label": "경고 기준", "color": "#E53935"}
  ],
  "breakdown": {
    "planned": {"label": "계획정지", "total_min": 45, "color": "#2196F3"},
    "unplanned": {"label": "비계획정지", "total_min": 125, "color": "#E53935"},
    "other": {"label": "기타", "total_min": 25, "color": "#9E9E9E"}
  },
  "oee_impact": {
    "availability_loss": 20.3,
    "production_loss_units": 3200
  }
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. 비가동 시간은 분 단위로 표시, 1시간 초과 시 시간 병기
2. 반드시 계획정지/비계획정지 구분하여 표시
3. 비계획정지(고장)는 원인과 조치내역 포함 필수
4. 반복 고장 설비는 별도 경고 표시
5. OEE 영향도(가용률 손실) 반드시 산출
6. 긴급/이번 주/개선제안 3단계로 권장사항 구분
7. 설비팀 즉시 조치 가능하도록 구체적 설비명, 위치, 원인 명시
==============================================================
"""
    },

    # ==================== LINE 차트 ====================
    "월별_생산량_추이": {
        "keywords": ["월별", "생산량", "추이", "트렌드", "생산추이"],
        "chart": ChartConfig("line", "글로우 효과 + 부드러운 곡선", "월별 생산량 추이"),
        "data_source": "fg_lot + production_order (월별 qty 합계)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 월별 생산량 추이 분석
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 월별 생산량 집계 (최근 12개월)
SELECT
    strftime('%Y-%m', f.production_dt) as prod_month,
    COUNT(DISTINCT f.lot_id) as lot_count,
    SUM(f.qty) as total_qty,
    ROUND(SUM(f.qty) / 1000.0, 1) as total_kl,
    COUNT(DISTINCT p.item_id) as item_variety
FROM fg_lot f
JOIN production_order p ON f.prod_order_id = p.prod_order_id
WHERE f.production_dt >= date('now', '-12 months')
  AND f.status = 'COMPLETED'
GROUP BY strftime('%Y-%m', f.production_dt)
ORDER BY prod_month;

-- 라인별 월간 생산량 (트렌드 분해용)
SELECT
    strftime('%Y-%m', f.production_dt) as prod_month,
    l.line_name,
    SUM(f.qty) as line_qty
FROM fg_lot f
JOIN production_order p ON f.prod_order_id = p.prod_order_id
JOIN line_mst l ON p.line_id = l.line_id
WHERE f.production_dt >= date('now', '-6 months')
GROUP BY strftime('%Y-%m', f.production_dt), l.line_name
ORDER BY prod_month, l.line_id;

-- 제품 카테고리별 생산 비중 추이
SELECT
    strftime('%Y-%m', f.production_dt) as prod_month,
    i.category,
    SUM(f.qty) as category_qty,
    ROUND(SUM(f.qty) * 100.0 / SUM(SUM(f.qty)) OVER (PARTITION BY strftime('%Y-%m', f.production_dt)), 1) as ratio
FROM fg_lot f
JOIN production_order p ON f.prod_order_id = p.prod_order_id
JOIN item_mst i ON p.item_id = i.item_id
WHERE f.production_dt >= date('now', '-6 months')
GROUP BY strftime('%Y-%m', f.production_dt), i.category;
----------------------------------------------------------

[2. 생산 능력 기준 정보]
----------------------------------------------------------
| 구분 | 수치 | 비고 |
|------|------|------|
| 일일 최대능력 | 80,000병 | 4개 라인 풀가동 |
| 월간 최대능력 | 2,080,000병 | 26일 기준 |
| 연간 생산규모 | 18,000 KL | 2024년 목표 |
| 현재 가동률 | 76~88% | 라인별 상이 |

[라인별 월간 목표]
- 1라인 (유산균음료): 월 390,000병
- 2라인 (과채음료): 월 520,000병
- 3라인 (단백질음료): 월 468,000병
- Pilot라인: 월 78,000병 (신제품 테스트)

* 월간 총 목표: 1,456,000병 (약 1,500 KL)
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[월간 생산량 달성률]
- 100% 이상: ✅ 초과달성 (GREEN)
- 95% ~ 100%: ✅ 정상 (GREEN)
- 90% ~ 95%: ⚠️ 주의 (YELLOW)
- 90% 미만: 🚨 경고 (RED)

[성장률 기준]
- 전월 대비 +5% 이상: 🔥 고성장
- 전월 대비 +0~5%: ✅ 안정 성장
- 전월 대비 -5~0%: ⚠️ 소폭 하락
- 전월 대비 -5% 이하: 🚨 감소 추세

[계절성 패턴]
- 성수기 (5~8월): 목표 +15% 상향
- 비수기 (12~2월): 목표 -10% 하향
- 일반기 (3~4, 9~11월): 기본 목표

[이동평균 기준]
- 3개월 이동평균 > 목표: 📈 상승 추세
- 3개월 이동평균 < 목표: 📉 하락 추세
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
생산량 이상 감지 시 자동으로 다음을 추가 조회합니다:

1) 월간 목표 미달 시 (90% 미만):
   → downtime_event에서 월간 비가동 시간 합계 조회
   → production_order에서 취소/연기 오더 건수 확인
   → 원자재 재고 부족 여부 점검 (inventory)

2) 특정 라인 생산량 급감 시:
   → 해당 라인 설비 고장 이력 조회
   → 주요 제품 수주 변동 확인
   → 인력 투입 현황 확인

3) 계절성 패턴 이탈 시:
   → 전년 동월 대비 비교 분석
   → 시장 수요 변화 확인 (sales_order)
   → 경쟁사 동향 참고 (외부 데이터)
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
월별 생산량 추이를 분석했습니다. (최근 12개월)

📈 [생산량 추이 데이터]
┌─────────┬───────────┬──────────┬─────────┬──────────┐
│ 월      │ 생산량    │ 목표     │ 달성률  │ 전월비   │
├─────────┼───────────┼──────────┼─────────┼──────────┤
│ 2024-01 │ 1,380,000 │ 1,310,000│ 105.3%  │ -       │
│ 2024-02 │ 1,290,000 │ 1,310,000│ 98.5%   │ -6.5% ↓ │
│ 2024-03 │ 1,420,000 │ 1,456,000│ 97.5%   │ +10.1% ↑│
│ 2024-04 │ 1,510,000 │ 1,456,000│ 103.7%  │ +6.3% ↑ │
│ 2024-05 │ 1,650,000 │ 1,674,000│ 98.6%   │ +9.3% ↑ │
│ 2024-06 │ 1,720,000 │ 1,674,000│ 102.7%  │ +4.2% ↑ │
├─────────┼───────────┼──────────┼─────────┼──────────┤
│ 상반기  │ 8,970,000 │ 8,880,000│ 101.0%  │ -       │
└─────────┴───────────┴──────────┴─────────┴──────────┘

📊 [트렌드 분석]
• 3개월 이동평균: 1,627,000병/월 📈 상승 추세
• 전년 동기 대비: +18.5% 성장
• 계절성: 6월 성수기 진입, 예상대로 상승

🏭 [라인별 기여도 분석]
┌────────┬───────────┬─────────┬──────────┐
│ 라인   │ 월평균    │ 기여율  │ 추세     │
├────────┼───────────┼─────────┼──────────┤
│ 1라인  │ 398,000   │ 26.8%   │ 안정 →   │
│ 2라인  │ 545,000   │ 36.7%   │ 상승 📈  │
│ 3라인  │ 478,000   │ 32.2%   │ 상승 📈  │
│ Pilot  │ 64,000    │ 4.3%    │ 변동 ↕   │
└────────┴───────────┴─────────┴──────────┘

🔮 [예측 분석]
다음 달(7월) 예측:
• 예상 생산량: 1,780,000병 (+3.5%)
• 근거: 성수기 지속 + 신규 OEM 수주 반영
• 신뢰구간: 1,720,000 ~ 1,840,000병 (95%)

🔍 [이상 징후 감지]
⚠️ 2월 생산량 감소 원인:
• 설 연휴 (3일 휴무) - 약 240,000병 손실
• 1라인 정기 PM (5일) - 약 75,000병 손실
• 계획된 감소로 이상 없음

💡 [권장사항]
1. 7~8월 성수기 대비:
   - 원자재 선행 발주 권장 (발효유 원료 2주 리드타임)
   - 2라인 주말 가동 검토 (예상 +120,000병/월)

2. 하반기 생산계획 조정:
   - 신규 단백질음료 런칭 (9월) 대비 3라인 캐파 확보
   - Pilot 라인 양산 전환 검토 (10월 목표)

3. 전년 대비 성장 추세 유지 전략:
   - 목표: 연간 18,000 KL (현재 진척률 49.8%)
   - 하반기 월평균 1,560,000병 필요
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chart_type": "line",
  "style": "glow_smooth_curve",
  "title": "월별 생산량 추이",
  "subtitle": "최근 12개월 (단위: 천 병)",
  "data": {
    "labels": ["2024-01", "2024-02", "2024-03", "2024-04", "2024-05", "2024-06"],
    "datasets": [
      {
        "name": "실제 생산량",
        "values": [1380, 1290, 1420, 1510, 1650, 1720],
        "color": "#2196F3",
        "fill": true
      },
      {
        "name": "3개월 이동평균",
        "values": [null, null, 1363, 1407, 1527, 1627],
        "color": "#FF9800",
        "lineStyle": "dashed"
      },
      {
        "name": "목표선",
        "values": [1310, 1310, 1456, 1456, 1674, 1674],
        "color": "#4CAF50",
        "lineStyle": "dotted"
      }
    ]
  },
  "annotations": [
    {"month": "2024-02", "label": "설 연휴", "type": "event"},
    {"month": "2024-05", "label": "성수기 시작", "type": "season"}
  ],
  "forecast": {
    "next_month": "2024-07",
    "predicted_value": 1780,
    "confidence_interval": [1720, 1840]
  },
  "trend": {
    "direction": "up",
    "strength": "moderate",
    "seasonality": "summer_peak"
  }
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. 생산량은 천 단위 콤마 표시, 큰 수는 KL 병기
2. 반드시 3개월 이동평균선 포함하여 트렌드 제시
3. 전월 대비, 전년 동기 대비 증감률 필수
4. 계절성(성수기/비수기) 패턴 반영한 분석
5. 라인별 기여도 분석으로 병목/성장 라인 식별
6. 다음 달 예측값과 신뢰구간 제시
7. 생산계획팀이 의사결정에 활용 가능한 구체적 권장사항
==============================================================
"""
    },

    "매출_트렌드": {
        "keywords": ["매출", "트렌드", "매출추이", "매출트렌드"],
        "chart": ChartConfig("line", "글로우 효과 + 부드러운 곡선", "매출 트렌드 분석"),
        "data_source": "sales_order + outbound (월별 출하금액 추이)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 매출 트렌드 분석
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 월별 매출 추이 (수주 기준 + 출하 기준 비교)
SELECT
    strftime('%Y-%m', s.so_date) as sales_month,
    SUM(d.order_qty * d.unit_price) as order_amount,
    COUNT(DISTINCT s.so_no) as order_count,
    SUM(CASE WHEN s.status = 'CLOSED' THEN d.order_qty * d.unit_price ELSE 0 END) as shipped_amount
FROM sales_order s
JOIN sales_order_dtl d ON s.so_no = d.so_no
WHERE s.so_date >= date('now', '-24 months')
GROUP BY strftime('%Y-%m', s.so_date)
ORDER BY sales_month;

-- 사업군별 매출 추이 (OEM/배합/ODM)
SELECT
    strftime('%Y-%m', s.so_date) as sales_month,
    CASE
        WHEN i.category LIKE '%OEM%' THEN 'OEM'
        WHEN i.category LIKE '%배합%' THEN '배합서비스'
        ELSE 'ODM'
    END as biz_type,
    SUM(d.order_qty * d.unit_price) as type_amount
FROM sales_order s
JOIN sales_order_dtl d ON s.so_no = d.so_no
JOIN item_mst i ON d.item_id = i.item_id
WHERE s.so_date >= date('now', '-12 months')
GROUP BY strftime('%Y-%m', s.so_date), biz_type
ORDER BY sales_month, biz_type;

-- 고객 채널별 매출 추이
SELECT
    strftime('%Y-%m', s.so_date) as sales_month,
    c.biz_type as channel,
    SUM(d.order_qty * d.unit_price) as channel_amount
FROM sales_order s
JOIN sales_order_dtl d ON s.so_no = d.so_no
JOIN customer_mst c ON s.customer_id = c.customer_id
WHERE s.so_date >= date('now', '-12 months')
GROUP BY strftime('%Y-%m', s.so_date), c.biz_type
ORDER BY sales_month;
----------------------------------------------------------

[2. 재무 현황 및 목표]
----------------------------------------------------------
| 구분 | 2022년 | 2023년 | 2024년(목표) | 성장률 |
|------|--------|--------|--------------|--------|
| 매출액 | 278억 | 326억 | 394억 | +20.9% |
| 영업이익 | 17.5억 | 19.3억 | 25.7억 | +33.2% |
| 영업이익률 | 6.2% | 5.9% | 6.5% | - |

[사업군별 매출 구성]
- OEM 제조: 220.6억 (56%) - 이커머스 D2C, 홈쇼핑 PB
- 배합서비스: 94.6억 (24%) - 기능성 원료 배합
- ODM 개발: 78.8억 (20%) - 맞춤형 제품 개발

[채널별 매출 구성]
- 국내 이커머스: 45%
- 홈쇼핑/TV: 25%
- 일본 수출: 15%
- 기타 B2B: 15%
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[월간 매출 성장률 기준]
- YoY +25% 이상: 🔥 고성장 (목표 초과)
- YoY +15~25%: ✅ 정상 성장 (목표 달성)
- YoY +5~15%: ⚠️ 저성장 (모니터링)
- YoY +5% 미만: 🚨 경고 (전략 재검토)

[분기별 목표 (2024년)]
- Q1: 90억 (비수기)
- Q2: 105억 (성장기)
- Q3: 110억 (성수기)
- Q4: 89억 (비수기)

[사업군별 건전성 기준]
- OEM 의존도: 60% 이하 유지 권장
- 수출 비중: 20% 이상 목표 (리스크 분산)
- ODM 수익률: 12% 이상 목표

[고객 집중도 기준]
- Top 3 고객 비중: 40% 이하 권장
- 신규 고객 비율: 월 10% 이상 목표
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
매출 이상 감지 시 자동으로 다음을 추가 조회합니다:

1) 매출 성장률 둔화 시 (YoY +5% 미만):
   → 채널별 매출 변화 상세 분석
   → 이탈 고객 리스트 조회 (3개월 무거래)
   → 경쟁사 가격 동향 참고

2) 특정 사업군 급락 시 (MoM -15% 이상):
   → 해당 사업군 주요 고객 주문 패턴 분석
   → 제품별 매출 변화 확인
   → 파이프라인(진행 중 프로젝트) 현황 조회

3) 수출 매출 변동 시:
   → 환율 변동 영향도 분석
   → 일본 시장 동향 참조
   → 납기 지연 여부 확인
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
매출 트렌드를 분석했습니다. (2023.07 ~ 2024.06)

📈 [매출 추이 분석]
┌─────────┬──────────┬──────────┬──────────┬──────────┐
│ 월      │ 수주액   │ 출하액   │ YoY 성장 │ 추세     │
├─────────┼──────────┼──────────┼──────────┼──────────┤
│ 2024-01 │ 29.8억   │ 28.5억   │ +18.2%   │ ✅       │
│ 2024-02 │ 28.2억   │ 27.8억   │ +15.5%   │ ✅       │
│ 2024-03 │ 31.6억   │ 30.9억   │ +22.4%   │ 🔥       │
│ 2024-04 │ 30.9억   │ 30.2억   │ +19.8%   │ ✅       │
│ 2024-05 │ 32.5억   │ 31.8억   │ +24.1%   │ 🔥       │
│ 2024-06 │ 35.2억   │ 34.5억   │ +28.3%   │ 🔥       │
├─────────┼──────────┼──────────┼──────────┼──────────┤
│ 누계    │ 188.2억  │ 183.7억  │ +21.4%   │ -       │
└─────────┴──────────┴──────────┴──────────┴──────────┘

📊 [트렌드 핵심 지표]
• 6개월 평균 성장률: +21.4% (목표 +20% 초과 달성)
• 수주-출하 갭: 평균 4.5억/월 (정상 범위)
• 성장 모멘텀: 📈 상승 (3개월 연속 성장률 확대)

🏢 [사업군별 트렌드]
┌────────────┬──────────┬─────────┬───────────┬───────────┐
│ 사업군     │ 6개월 합 │ 비중    │ YoY 성장  │ 추세      │
├────────────┼──────────┼─────────┼───────────┼───────────┤
│ OEM 제조   │ 105.4억  │ 56.0%   │ +18.5%    │ 안정 →    │
│ 배합서비스 │ 45.2억   │ 24.0%   │ +32.1%    │ 급성장 📈 │
│ ODM 개발   │ 37.6억   │ 20.0%   │ +15.8%    │ 성장 ↗    │
└────────────┴──────────┴─────────┴───────────┴───────────┘

💡 인사이트: 배합서비스 고성장! 고마진 사업군 확대 중

📡 [채널별 트렌드]
• 이커머스 D2C: +35.2% (건강음료 트렌드 수혜)
• 홈쇼핑/TV: +8.5% (성장 둔화)
• 일본 수출: +42.8% (신규 거래선 확보)
• 기타 B2B: +12.3% (안정 성장)

🔮 [예측 및 전망]
하반기 예상:
• Q3 예상: 108.5억 (목표 110억의 98.6%)
• Q4 예상: 95.2억 (목표 89억 초과 예상)
• 2024년 연간: 401.9억 (목표 394억 대비 +2.0%)

📉 [리스크 요인]
⚠️ 홈쇼핑 채널 성장 둔화
- 전년 대비 성장률 8.5%로 전체 평균(21.4%) 하회
- 주요 원인: PB 브랜드 경쟁 심화
- 조치: 신규 홈쇼핑 입점 협의 중 (○○홈쇼핑)

💡 [전략적 권장사항]
1. 배합서비스 확대 전략
   - 고마진(15%) 사업군 집중 육성
   - 프리미엄 기능성 원료 라인업 확대
   - 목표: 2025년 비중 30%

2. 일본 수출 가속화
   - 현재 비중 15% → 2025년 목표 20%
   - 신규 거래선 3개사 추가 확보 목표
   - 일본 FSSC 인증 활용 마케팅

3. 홈쇼핑 채널 활성화
   - 차별화 제품 기획 (당사 독점 제형)
   - 신규 쇼핑몰 입점 확대
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chart_type": "line",
  "style": "glow_smooth_curve",
  "title": "매출 트렌드 분석",
  "subtitle": "2023.07 ~ 2024.06 (단위: 억원)",
  "data": {
    "labels": ["2023-07", "2023-08", "2023-09", "2023-10", "2023-11", "2023-12",
               "2024-01", "2024-02", "2024-03", "2024-04", "2024-05", "2024-06"],
    "datasets": [
      {
        "name": "실제 매출",
        "values": [27.5, 29.2, 28.8, 26.5, 25.8, 27.2, 29.8, 28.2, 31.6, 30.9, 32.5, 35.2],
        "color": "#2196F3",
        "fill": true,
        "fillOpacity": 0.3
      },
      {
        "name": "전년 동기",
        "values": [23.3, 24.1, 23.5, 22.1, 21.8, 23.0, 25.2, 24.4, 25.8, 25.8, 26.2, 27.4],
        "color": "#9E9E9E",
        "lineStyle": "dashed"
      },
      {
        "name": "목표선",
        "values": [28.0, 29.0, 29.0, 27.0, 27.0, 28.0, 28.0, 28.0, 32.8, 32.8, 38.0, 38.0],
        "color": "#4CAF50",
        "lineStyle": "dotted"
      }
    ]
  },
  "annotations": [
    {"month": "2024-03", "label": "신규 OEM 계약", "type": "event"},
    {"month": "2024-05", "label": "성수기 시작", "type": "season"}
  ],
  "growth_metrics": {
    "yoy_growth": 21.4,
    "mom_growth": 8.3,
    "trend_direction": "up"
  },
  "breakdown": {
    "oem": {"value": 105.4, "ratio": 56.0, "growth": 18.5},
    "formulation": {"value": 45.2, "ratio": 24.0, "growth": 32.1},
    "odm": {"value": 37.6, "ratio": 20.0, "growth": 15.8}
  }
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. 매출 금액은 억원 단위, 소수점 1자리까지 표시
2. YoY(전년 동기비) 성장률 필수 포함
3. 수주액과 출하액 구분하여 매출 인식 시점 명확화
4. 사업군별(OEM/배합/ODM) 트렌드 분석 필수
5. 채널별 성장률 차이 분석으로 집중 영역 제시
6. 경영진 의사결정용으로 전략적 인사이트 포함
7. 리스크 요인과 기회 요인 균형있게 제시
==============================================================
"""
    },

    "온도_변화": {
        "keywords": ["온도", "변화", "온도추이", "온도변화", "살균", "살균온도"],
        "chart": ChartConfig("line", "글로우 효과 + 부드러운 곡선", "공정 온도 변화 추이"),
        "data_source": "sensor_log + param_mst (TEMP 시계열)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 살균공정 온도 변화 모니터링 (CCP)
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 살균기별 실시간 온도 추이 (최근 8시간)
SELECT
    s.sensor_id,
    e.equip_name,
    l.line_name,
    strftime('%H:%M', s.log_dt) as log_time,
    s.param_value as temperature,
    p.lower_limit,
    p.upper_limit,
    CASE
        WHEN s.param_value < p.lower_limit THEN 'UNDER'
        WHEN s.param_value > p.upper_limit THEN 'OVER'
        ELSE 'NORMAL'
    END as status
FROM sensor_log s
JOIN equipment_mst e ON s.equip_id = e.equip_id
JOIN line_mst l ON e.line_id = l.line_id
JOIN param_mst p ON s.param_id = p.param_id
WHERE s.log_dt >= datetime('now', '-8 hours')
  AND p.param_type = 'TEMP'
  AND e.equip_type = 'UHT'
ORDER BY s.log_dt DESC;

-- CCP 이탈 이벤트 조회
SELECT
    c.check_id,
    c.check_dt,
    e.equip_name,
    l.line_name,
    c.check_value,
    c.lower_limit,
    c.upper_limit,
    c.result_flag,
    c.action_taken,
    c.lot_id
FROM ccp_check_log c
JOIN equipment_mst e ON c.equip_id = e.equip_id
JOIN line_mst l ON e.line_id = l.line_id
WHERE DATE(c.check_dt) = DATE('now')
  AND c.result_flag = 'FAIL'
ORDER BY c.check_dt DESC;

-- 살균기별 온도 통계 (시간대별)
SELECT
    e.equip_name,
    strftime('%H', s.log_dt) as hour,
    ROUND(AVG(s.param_value), 1) as avg_temp,
    ROUND(MIN(s.param_value), 1) as min_temp,
    ROUND(MAX(s.param_value), 1) as max_temp,
    ROUND((MAX(s.param_value) - MIN(s.param_value)), 1) as temp_range,
    COUNT(CASE WHEN s.param_value < 85 THEN 1 END) as under_count
FROM sensor_log s
JOIN equipment_mst e ON s.equip_id = e.equip_id
JOIN param_mst p ON s.param_id = p.param_id
WHERE s.log_dt >= datetime('now', '-8 hours')
  AND p.param_type = 'TEMP'
  AND e.equip_type = 'UHT'
GROUP BY e.equip_name, strftime('%H', s.log_dt)
ORDER BY e.equip_name, hour;
----------------------------------------------------------

[2. CCP 관리 기준 (HACCP)]
----------------------------------------------------------
| CCP 항목 | 설비 | 기준온도 | 허용범위 | 유지시간 | 모니터링 주기 |
|----------|------|----------|----------|----------|---------------|
| 살균온도 | UHT-01 | 90℃ | 85~95℃ | 30초 이상 | 연속 측정 |
| 살균온도 | UHT-02 | 90℃ | 85~95℃ | 30초 이상 | 연속 측정 |
| 살균온도 | UHT-03 | 90℃ | 85~95℃ | 30초 이상 | 연속 측정 |

[CCP 이탈 시 조치 절차]
1. 즉시 생산 중단
2. 해당 LOT 격리 (격리창고 이동)
3. 설비 점검 및 원인 분석
4. 재살균 또는 폐기 결정
5. HACCP 기록 문서화

[센서 정보]
- 측정 주기: 5초 (실시간 연속)
- 정확도: ±0.5℃
- 캘리브레이션: 월 1회
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[온도 상태 판정]
- 85℃ ~ 95℃: ✅ 정상 (GREEN) - CCP 합격
- 80℃ ~ 85℃: ⚠️ 주의 (YELLOW) - 즉시 확인 필요
- 95℃ ~ 100℃: ⚠️ 주의 (YELLOW) - 과열 확인
- 80℃ 미만: 🚨 이탈 (RED) - 생산 중단, LOT 격리
- 100℃ 초과: 🚨 이탈 (RED) - 설비 이상, 점검

[온도 변동 판정]
- 변동폭 ≤2℃/분: ✅ 안정 (정상 운전)
- 변동폭 2~5℃/분: ⚠️ 불안정 (모니터링 강화)
- 변동폭 >5℃/분: 🚨 이상 (설비 점검 필요)

[연속 이탈 기준]
- 1회 이탈: 해당 LOT만 격리
- 2회 연속 이탈: 생산 중단, 원인 분석
- 3회 이상 이탈: 설비 정밀 진단 필수

[알람 등급]
- INFO: 온도 경계값 접근 (82℃ 또는 93℃)
- WARNING: 온도 주의 구간 (80~85℃, 95~100℃)
- CRITICAL: 온도 이탈 (<80℃, >100℃)
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
온도 이상 감지 시 자동으로 다음을 추가 조회합니다:

1) 온도 이탈 발생 시 (CCP FAIL):
   → 해당 시간대 생산 LOT 자동 식별
   → LOT 상태 변경 이력 추적
   → 이탈 전후 30분간 온도 데이터 상세 조회
   → 이전 동일 패턴 이력 검색

2) 온도 변동폭 이상 시 (>5℃/분):
   → alarm_event에서 설비 알람 이력 조회
   → 스팀 공급 압력 센서 데이터 연계
   → 전력 사용량 이상 여부 확인

3) 특정 설비 반복 이탈 시:
   → 최근 7일간 해당 설비 이탈 패턴 분석
   → PM 이력 및 부품 교체 이력 조회
   → 유사 설비 (다른 라인) 비교 분석
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
살균공정 온도 모니터링 현황입니다. (2024-01-15 16:30 기준)

🌡️ [실시간 온도 현황]
┌───────────┬────────┬──────────┬──────────┬─────────┐
│ 설비      │ 라인   │ 현재온도 │ 기준     │ 상태    │
├───────────┼────────┼──────────┼──────────┼─────────┤
│ UHT-01    │ 1라인  │ 91.2℃   │ 85~95℃  │ ✅ 정상 │
│ UHT-02    │ 2라인  │ 83.5℃   │ 85~95℃  │ ⚠️ 주의 │
│ UHT-03    │ 3라인  │ 89.8℃   │ 85~95℃  │ ✅ 정상 │
└───────────┴────────┴──────────┴──────────┴─────────┘

📊 [금일 온도 추이 분석]
• 측정 횟수: 17,280회 (3대 × 8시간 × 720회)
• 평균 온도: 89.7℃
• 최저/최고: 82.1℃ / 96.3℃
• 이탈 건수: 3건 (0.02%)

📈 [시간대별 추이 - UHT-02]
08:00 ████████████████████████████████████ 90.5℃ ✅
09:00 ███████████████████████████████████░ 89.2℃ ✅
10:00 ██████████████████████████████████░░ 88.1℃ ✅
11:00 █████████████████████████████████░░░ 86.8℃ ✅
12:00 ████████████████████████████░░░░░░░░ 82.5℃ ⚠️ ← 점심 라인정지 후 재가동
13:00 ██████████████████████████████████░░ 87.9℃ ✅
14:00 ████████████████████████████░░░░░░░░ 83.5℃ ⚠️ ← 현재

🚨 [CCP 이탈 이벤트]
┌──────────┬───────────┬────────┬────────┬─────────────────┐
│ 시간     │ 설비      │ 온도   │ LOT    │ 조치            │
├──────────┼───────────┼────────┼────────┼─────────────────┤
│ 12:15    │ UHT-02    │ 78.3℃ │ L240115-02 │ LOT 격리, 재살균 │
│ 12:18    │ UHT-02    │ 81.2℃ │ L240115-02 │ 복구 진행 중    │
│ 14:25    │ UHT-02    │ 84.1℃ │ L240115-08 │ 모니터링 중     │
└──────────┴───────────┴────────┴────────┴─────────────────┘

🔍 [자동 분석 결과]
⚠️ UHT-02 온도 불안정 감지!

[패턴 분석]
• 12:00~12:30 점심시간 라인정지 후 재가동 시 온도 미도달
• 14:00~ 현재 온도 하락 추세 (90.5℃ → 83.5℃)
• 온도 변동폭: 3.2℃/분 (불안정)

[원인 추정]
1. 스팀 공급 압력 저하 가능성
   - 현재 스팀 압력: 2.8 bar (기준 3.0 bar)
2. 제품 유량 증가로 인한 열교환 불충분
   - 현재 유량: 2,500 L/hr (기준 2,200 L/hr)

[격리 LOT 현황]
• L240115-02: 1,200병, 격리창고 보관 중
• 조치: 재살균 진행 예정 (16:30)

💡 [즉시 조치사항]
1. [긴급] UHT-02 현장 확인
   - 스팀 밸브 개도율 확인 (현재 85% → 100% 조정 권장)
   - 제품 유량 조절 (2,500 → 2,200 L/hr)

2. [모니터링] 15분 간격 수동 온도 확인
   - 자동 센서와 휴대용 온도계 교차 검증
   - 이상 지속 시 생산 중단 결정

3. [기록] HACCP 문서화
   - 이탈 시간, 온도, LOT, 조치내역 기록
   - 격리 LOT 재살균 후 검사 결과 기록

📋 [금일 CCP 합격률]
• 전체: 99.98% (17,277/17,280건)
• UHT-01: 100.00% (정상)
• UHT-02: 99.95% (이탈 3건)
• UHT-03: 100.00% (정상)
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chart_type": "line",
  "style": "glow_smooth_curve",
  "title": "살균공정 온도 추이 (CCP 모니터링)",
  "subtitle": "2024-01-15 08:00~16:30",
  "realtime": true,
  "data": {
    "labels": ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00"],
    "datasets": [
      {
        "name": "UHT-01",
        "values": [90.5, 90.2, 89.8, 90.1, 89.5, 90.3, 90.8, 90.2, 90.5],
        "color": "#4CAF50",
        "lineWidth": 2
      },
      {
        "name": "UHT-02",
        "values": [90.5, 89.2, 88.1, 86.8, 82.5, 87.9, 83.5, 84.2, 85.1],
        "color": "#FF9800",
        "lineWidth": 2,
        "alerts": [
          {"time": "12:00", "value": 82.5, "type": "warning"},
          {"time": "14:00", "value": 83.5, "type": "warning"}
        ]
      },
      {
        "name": "UHT-03",
        "values": [89.8, 90.1, 89.5, 89.9, 90.2, 89.7, 90.0, 89.8, 90.1],
        "color": "#2196F3",
        "lineWidth": 2
      }
    ]
  },
  "threshold_zones": [
    {"min": 0, "max": 80, "color": "#FFCDD2", "label": "이탈 (저온)"},
    {"min": 80, "max": 85, "color": "#FFF9C4", "label": "주의"},
    {"min": 85, "max": 95, "color": "#C8E6C9", "label": "정상 (CCP 합격)"},
    {"min": 95, "max": 100, "color": "#FFF9C4", "label": "주의"},
    {"min": 100, "max": 120, "color": "#FFCDD2", "label": "이탈 (과열)"}
  ],
  "reference_lines": [
    {"value": 85, "label": "하한선", "color": "#E53935", "style": "dashed"},
    {"value": 90, "label": "목표", "color": "#4CAF50", "style": "solid"},
    {"value": 95, "label": "상한선", "color": "#E53935", "style": "dashed"}
  ],
  "ccp_events": [
    {"time": "12:15", "equip": "UHT-02", "value": 78.3, "type": "FAIL", "lot": "L240115-02"}
  ]
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. 온도는 소수점 1자리까지 표시 (예: 89.5℃)
2. CCP 이탈 시 반드시 해당 LOT ID 명시
3. 이탈 구간은 빨간색/노란색으로 시각적 강조
4. 기준 온도선(85℃, 95℃) 반드시 차트에 표시
5. 시간대별 추이로 패턴 파악 가능하도록 제시
6. 즉시 조치사항은 구체적이고 실행 가능하게 작성
7. HACCP 기록 요건 충족을 위한 문서화 안내 포함
8. QA팀이 5초 내 판단할 수 있도록 상태 아이콘 활용
==============================================================
"""
    },

    # ==================== PIE 차트 ====================
    "품질검사_결과": {
        "keywords": ["품질검사", "품질", "검사결과", "QC", "검사"],
        "chart": ChartConfig("pie", "도넛 스타일 + 그림자", "품질검사 결과 분포"),
        "data_source": "qc_test (final_status 별 비율)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 품질검사 결과 분포 분석
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 검사 결과별 분포
SELECT
    final_status,
    COUNT(*) as test_count,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 1) as ratio
FROM qc_test
WHERE test_dt >= date('now', '-30 days')
GROUP BY final_status
ORDER BY test_count DESC;

-- 검사 유형별 합격률
SELECT
    test_type,
    COUNT(*) as total_tests,
    COUNT(CASE WHEN final_status = 'PASS' THEN 1 END) as pass_count,
    COUNT(CASE WHEN final_status = 'HOLD' THEN 1 END) as hold_count,
    COUNT(CASE WHEN final_status = 'REJECT' THEN 1 END) as reject_count,
    ROUND(COUNT(CASE WHEN final_status = 'PASS' THEN 1 END) * 100.0 / COUNT(*), 2) as pass_rate
FROM qc_test
WHERE test_dt >= date('now', '-30 days')
GROUP BY test_type;

-- 불합격 원인 분석
SELECT
    test_type,
    test_item,
    COUNT(*) as fail_count,
    ROUND(AVG(test_value), 2) as avg_value,
    ROUND(AVG(lower_limit), 2) as spec_lower,
    ROUND(AVG(upper_limit), 2) as spec_upper
FROM qc_test
WHERE test_dt >= date('now', '-30 days')
  AND final_status IN ('HOLD', 'REJECT')
GROUP BY test_type, test_item
ORDER BY fail_count DESC
LIMIT 10;

-- 주간 품질 트렌드
SELECT
    strftime('%Y-W%W', test_dt) as week,
    ROUND(COUNT(CASE WHEN final_status = 'PASS' THEN 1 END) * 100.0 / COUNT(*), 2) as weekly_pass_rate
FROM qc_test
WHERE test_dt >= date('now', '-8 weeks')
GROUP BY strftime('%Y-W%W', test_dt)
ORDER BY week;
----------------------------------------------------------

[2. 검사 항목 기준 정보]
----------------------------------------------------------
[원료검사 (RM) - Incoming Quality]
| 검사항목 | 기준 | 허용범위 | 검사주기 |
|----------|------|----------|----------|
| 수분함량 | 제품별 상이 | ±1% | 입고시 |
| 미생물 | 규격내 | 음성 | 입고시 |
| 이물검사 | 무검출 | - | 입고시 |
| COA 적합성 | 규격일치 | - | 입고시 |

[공정검사 (PROCESS) - In-Process Quality]
| 검사항목 | 기준 | 허용범위 | 검사주기 |
|----------|------|----------|----------|
| pH | 제품별 상이 | ±0.2 | 배합 후 |
| Brix | 제품별 상이 | ±0.5 | 배합 후 |
| 점도 | 제품별 상이 | ±5% | 배합 후 |
| 배합농도 | 규격값 | ±2% | 배합 후 |

[완제품검사 (FG) - Final Quality]
| 검사항목 | 기준 | 허용범위 | 검사주기 |
|----------|------|----------|----------|
| 미생물 | 음성 | - | LOT당 |
| 외관검사 | 이상없음 | - | LOT당 |
| 충진중량 | 표시중량 | ±3% | LOT당 |
| 내압검사 | 파손없음 | - | LOT당 |
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[전체 합격률 기준]
- 99% 이상: ✅ 우수 (GREEN)
- 97% ~ 99%: ✅ 정상 (GREEN)
- 95% ~ 97%: ⚠️ 주의 (YELLOW)
- 95% 미만: 🚨 경고 (RED)

[검사 유형별 목표 합격률]
- 원료검사 (RM): 99.5% 이상
- 공정검사 (PROCESS): 98% 이상
- 완제품검사 (FG): 99.8% 이상

[HOLD 비율 기준]
- 1% 이하: ✅ 정상
- 1% ~ 3%: ⚠️ 주의 - 원인 분석 필요
- 3% 초과: 🚨 경고 - 즉시 대응 필요

[REJECT 비율 기준]
- 0.5% 이하: ✅ 정상
- 0.5% ~ 1%: ⚠️ 주의
- 1% 초과: 🚨 경고 - 품질 비용 증가
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
품질 이상 감지 시 자동으로 다음을 추가 조회합니다:

1) 합격률 95% 미만 시:
   → 불합격 항목 TOP 5 원인 분석
   → 해당 항목 주간 트렌드 조회
   → 관련 원료 LOT 역추적

2) 특정 검사항목 불합격 급증 시:
   → 원료 공급업체별 품질 비교
   → 설비 파라미터 이상 여부 확인
   → 환경 조건(온습도) 변화 확인

3) HOLD 비율 3% 초과 시:
   → HOLD → PASS 전환율 분석
   → HOLD 평균 처리 시간 조회
   → 재검사 필요 LOT 현황
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
품질검사 결과 분포를 분석했습니다. (최근 30일)

🔬 [검사 결과 분포]
┌────────────┬──────────┬─────────┬─────────┐
│ 결과       │ 건수     │ 비율    │ 상태    │
├────────────┼──────────┼─────────┼─────────┤
│ ✅ PASS    │ 4,521건  │ 97.8%   │ 정상    │
│ ⏸️ HOLD    │ 85건     │ 1.8%    │ 주의    │
│ ❌ REJECT  │ 18건     │ 0.4%    │ 정상    │
├────────────┼──────────┼─────────┼─────────┤
│ 합계       │ 4,624건  │ 100%    │ -       │
└────────────┴──────────┴─────────┴─────────┘

📊 [검사 유형별 합격률]
┌────────────┬──────────┬─────────┬─────────┬─────────┐
│ 유형       │ 검사건수 │ PASS    │ 합격률  │ 목표    │
├────────────┼──────────┼─────────┼─────────┼─────────┤
│ 원료(RM)   │ 892건    │ 885건   │ 99.2%   │ 99.5%   │
│ 공정(PROC) │ 2,156건  │ 2,098건 │ 97.3%   │ 98.0%   │
│ 완제품(FG) │ 1,576건  │ 1,538건 │ 97.6%   │ 99.8%   │
└────────────┴──────────┴─────────┴─────────┴─────────┘

🔍 [불합격 원인 TOP 5]
┌────┬─────────────┬────────┬──────────┬──────────┐
│ #  │ 항목        │ 건수   │ 측정평균 │ 규격     │
├────┼─────────────┼────────┼──────────┼──────────┤
│ 1  │ 공정-Brix   │ 32건   │ 10.8     │ 11.0±0.5 │
│ 2  │ 완제품-충진 │ 28건   │ 188mL    │ 200±6mL  │
│ 3  │ 공정-pH     │ 18건   │ 3.85     │ 4.0±0.2  │
│ 4  │ 원료-수분   │ 15건   │ 6.2%     │ 5.0±1%   │
│ 5  │ 완제품-외관 │ 10건   │ -        │ 이상없음 │
└────┴─────────────┴────────┴──────────┴──────────┘

📈 [주간 품질 트렌드]
W01: ████████████████████████████████████ 98.5% ✅
W02: ███████████████████████████████████░ 97.8% ✅
W03: ██████████████████████████████████░░ 97.2% ⚠️
W04: ███████████████████████████████████░ 97.8% ✅

🔍 [자동 분석 결과]
⚠️ 공정검사 합격률 목표(98%) 미달!

[원인 분석]
• Brix 불합격 32건 - 2라인 배합탱크 집중 발생
  - MIX-5T-02 탱크 배합 LOT에서 62% 발생
  - 원인: 원액 농도 변동 + 급수량 편차
• 충진중량 불합격 28건 - 3라인 충진기
  - 평균 188mL로 하한(194mL) 미달
  - 원인: 충진노즐 막힘 의심

💡 [품질 개선 권장사항]
1. [긴급] 3라인 FILL-03 노즐 분해청소
   - 충진중량 편차 원인 제거
   - 예상 소요: 2시간

2. [이번 주] 2라인 배합공정 표준화
   - 원액 투입량 재설정 (현재 95L → 98L)
   - 급수량 자동제어 밸브 캘리브레이션

3. [월간] 검사원 역량 강화 교육
   - 외관검사 판정 기준 재교육
   - 측정기기 사용법 실습

📋 [HOLD 처리 현황]
• 현재 HOLD: 85건 (처리 대기 42건)
• 평균 처리시간: 4.2시간
• HOLD → PASS 전환율: 78%
• HOLD → REJECT 전환율: 22%
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chart_type": "pie",
  "style": "donut_shadow",
  "title": "품질검사 결과 분포",
  "subtitle": "최근 30일 (총 4,624건)",
  "innerRadius": 60,
  "data": [
    {
      "name": "PASS",
      "value": 4521,
      "ratio": 97.8,
      "color": "#4CAF50",
      "icon": "✅"
    },
    {
      "name": "HOLD",
      "value": 85,
      "ratio": 1.8,
      "color": "#FFC107",
      "icon": "⏸️"
    },
    {
      "name": "REJECT",
      "value": 18,
      "ratio": 0.4,
      "color": "#F44336",
      "icon": "❌"
    }
  ],
  "center_text": {
    "main": "97.8%",
    "sub": "합격률"
  },
  "breakdown_by_type": {
    "RM": {"pass_rate": 99.2, "total": 892},
    "PROCESS": {"pass_rate": 97.3, "total": 2156},
    "FG": {"pass_rate": 97.6, "total": 1576}
  },
  "top_failures": [
    {"item": "Brix", "type": "PROCESS", "count": 32},
    {"item": "충진중량", "type": "FG", "count": 28},
    {"item": "pH", "type": "PROCESS", "count": 18}
  ]
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. PASS/HOLD/REJECT 3가지 상태 색상 구분 필수
2. 건수와 비율(%) 동시 표시
3. 검사 유형별(RM/PROCESS/FG) 합격률 비교 포함
4. 불합격 원인 TOP 5와 구체적 측정값 제시
5. 주간 트렌드로 품질 추이 파악 가능하도록
6. HOLD 처리 현황 및 전환율 정보 제공
7. QC팀 즉시 조치 가능한 구체적 개선사항 권장
==============================================================
"""
    },

    "창고별_재고": {
        "keywords": ["창고별", "재고", "재고비율", "재고현황", "창고"],
        "chart": ChartConfig("pie", "도넛 스타일 + 그림자", "창고별 재고 비율"),
        "data_source": "inventory (warehouse_id 별 qty 합계)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 창고별 재고 현황 분석
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 창고별 재고 현황 집계
SELECT
    w.warehouse_id,
    w.warehouse_name,
    w.storage_type,
    w.capacity_pallet,
    COUNT(DISTINCT i.item_id) as item_count,
    SUM(i.qty_on_hand) as total_qty,
    SUM(i.qty_on_hand * im.unit_cost) as inventory_value,
    ROUND(SUM(i.qty_on_hand) * 100.0 / w.capacity_pallet, 1) as utilization
FROM inventory i
JOIN warehouse_mst w ON i.warehouse_id = w.warehouse_id
JOIN item_mst im ON i.item_id = im.item_id
WHERE i.qty_on_hand > 0
GROUP BY w.warehouse_id, w.warehouse_name, w.storage_type, w.capacity_pallet;

-- 품목 유형별 재고 분포
SELECT
    w.warehouse_name,
    im.item_type,
    SUM(i.qty_on_hand) as type_qty,
    SUM(i.qty_on_hand * im.unit_cost) as type_value
FROM inventory i
JOIN warehouse_mst w ON i.warehouse_id = w.warehouse_id
JOIN item_mst im ON i.item_id = im.item_id
WHERE i.qty_on_hand > 0
GROUP BY w.warehouse_name, im.item_type;

-- 재고 회전율 분석 (최근 30일)
SELECT
    im.item_type,
    SUM(i.qty_on_hand) as current_stock,
    SUM(o.outbound_qty) as monthly_usage,
    ROUND(SUM(o.outbound_qty) * 1.0 / NULLIF(SUM(i.qty_on_hand), 0), 2) as turnover_rate,
    ROUND(SUM(i.qty_on_hand) * 30.0 / NULLIF(SUM(o.outbound_qty), 0), 1) as days_on_hand
FROM inventory i
JOIN item_mst im ON i.item_id = im.item_id
LEFT JOIN (
    SELECT item_id, SUM(qty) as outbound_qty
    FROM outbound
    WHERE outbound_dt >= date('now', '-30 days')
    GROUP BY item_id
) o ON i.item_id = o.item_id
GROUP BY im.item_type;

-- 안전재고 대비 현황
SELECT
    im.item_name,
    im.item_type,
    i.qty_on_hand,
    im.safety_stock,
    im.reorder_point,
    CASE
        WHEN i.qty_on_hand <= im.safety_stock THEN 'CRITICAL'
        WHEN i.qty_on_hand <= im.reorder_point THEN 'REORDER'
        ELSE 'OK'
    END as stock_status
FROM inventory i
JOIN item_mst im ON i.item_id = im.item_id
WHERE i.qty_on_hand <= im.reorder_point * 1.2
ORDER BY i.qty_on_hand * 1.0 / NULLIF(im.safety_stock, 0);
----------------------------------------------------------

[2. 창고 마스터 정보]
----------------------------------------------------------
| 창고코드 | 창고명 | 위치 | 보관조건 | 용량 | 비고 |
|----------|--------|------|----------|------|------|
| WH01 | 원료창고 | 1공장 | 상온/냉장 | 200 Pallet | 원료·부자재 |
| WH02 | 포장재창고 | 1공장 | 상온 | 150 Pallet | PET, 라벨, 캡 |
| WH03 | 완제품창고 | 2공장 | 상온 | 300 Pallet | 출하 대기 |
| WH04 | 저온창고 | 2공장 | 0~5℃ | 300 Pallet | 냉장 제품 |
| WH05 | 격리창고 | 2공장 | 상온 | 50 Pallet | QC 대기/불합격 |

[보관 조건별 구분]
- 상온: 15~25℃, 습도 60% 이하
- 냉장: 0~5℃, 유산균 음료 등
- 격리: 품질검사 대기, 반품, 폐기 대기
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[창고 가용률 기준]
- 50% 이하: ✅ 여유 (GREEN) - 추가 입고 가능
- 50% ~ 75%: ✅ 정상 (GREEN)
- 75% ~ 90%: ⚠️ 주의 (YELLOW) - 공간 확보 필요
- 90% 초과: 🚨 경고 (RED) - 긴급 출하 또는 외부 보관

[재고 회전율 기준 (월간)]
- 완제품: 4회 이상 → 정상 (7.5일 이내 출하)
- 원료: 2회 이상 → 정상 (15일 이내 소진)
- 포장재: 1.5회 이상 → 정상 (20일 이내 소진)

[안전재고 기준]
- 현재고 > 발주점: ✅ 정상
- 안전재고 < 현재고 ≤ 발주점: ⚠️ 발주 필요
- 현재고 ≤ 안전재고: 🚨 긴급 발주

[재고 금액 비율 기준]
- 완제품: 전체의 40~50% 권장
- 원료: 전체의 30~40% 권장
- 포장재: 전체의 15~20% 권장
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
재고 이상 감지 시 자동으로 다음을 추가 조회합니다:

1) 창고 가용률 90% 초과 시:
   → 출하 예정 오더 조회 (sales_order)
   → 장기 체류 재고 리스트 (90일 이상)
   → 외부 창고 이동 가능 물량 산출

2) 안전재고 미달 품목 발생 시:
   → 해당 품목 발주 이력 조회
   → 리드타임 및 예상 입고일 확인
   → 대체 가능 품목 검토

3) 재고 회전율 저하 시:
   → 해당 품목 판매 트렌드 분석
   → 유통기한 임박 재고 확인
   → 프로모션/할인 판매 대상 선정
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
창고별 재고 현황을 분석했습니다. (2024-01-15 16:30 기준)

📦 [창고별 재고 현황]
┌──────────────┬────────────┬────────┬─────────┬─────────┐
│ 창고         │ 재고량     │ 용량   │ 가용률  │ 상태    │
├──────────────┼────────────┼────────┼─────────┼─────────┤
│ 완제품창고   │ 245 Pallet │ 300    │ 81.7%   │ ⚠️ 주의 │
│ 저온창고     │ 198 Pallet │ 300    │ 66.0%   │ ✅ 정상 │
│ 원료창고     │ 142 Pallet │ 200    │ 71.0%   │ ✅ 정상 │
│ 포장재창고   │ 98 Pallet  │ 150    │ 65.3%   │ ✅ 정상 │
│ 격리창고     │ 12 Pallet  │ 50     │ 24.0%   │ ✅ 여유 │
├──────────────┼────────────┼────────┼─────────┼─────────┤
│ 합계         │ 695 Pallet │ 1,000  │ 69.5%   │ ✅ 정상 │
└──────────────┴────────────┴────────┴─────────┴─────────┘

💰 [재고 금액 분포]
┌──────────────┬────────────┬─────────┬─────────┐
│ 품목유형     │ 재고금액   │ 비율    │ 권장    │
├──────────────┼────────────┼─────────┼─────────┤
│ 완제품 (FG)  │ 8.5억원    │ 48.3%   │ 40~50%  │
│ 원료 (RM)    │ 6.2억원    │ 35.2%   │ 30~40%  │
│ 포장재 (PKG) │ 2.9억원    │ 16.5%   │ 15~20%  │
├──────────────┼────────────┼─────────┼─────────┤
│ 합계         │ 17.6억원   │ 100%    │ -       │
└──────────────┴────────────┴─────────┴─────────┘

📊 [재고 회전율 분석]
┌──────────────┬────────────┬───────────┬───────────┬─────────┐
│ 품목유형     │ 현재고     │ 월 사용량 │ 회전율    │ 재고일수│
├──────────────┼────────────┼───────────┼───────────┼─────────┤
│ 완제품       │ 443 Pallet │ 1,520     │ 3.4회     │ 8.7일   │
│ 원료         │ 142 Pallet │ 320       │ 2.3회     │ 13.3일  │
│ 포장재       │ 98 Pallet  │ 180       │ 1.8회     │ 16.3일  │
└──────────────┴────────────┴───────────┴───────────┴─────────┘

🔍 [자동 분석 결과]
⚠️ 완제품창고 가용률 81.7% - 공간 확보 필요!

[원인 분석]
• 이번 주 출하 지연: 3건 (△△ D2C 물류센터 입고 지연)
• 예정 출하량: 85 Pallet (1/16~1/17)
• 출하 완료 시 예상 가용률: 53.3%

⚠️ 안전재고 미달 품목 발견!
┌──────────────────┬────────┬────────┬──────────┐
│ 품목             │ 현재고 │ 안전   │ 상태     │
├──────────────────┼────────┼────────┼──────────┤
│ 유산균 원액 A    │ 280kg  │ 500kg  │ 🚨 긴급  │
│ PET 500mL 용기   │ 12,000 │ 15,000 │ ⚠️ 발주  │
│ 라벨 (3라인용)   │ 8,500  │ 10,000 │ ⚠️ 발주  │
└──────────────────┴────────┴────────┴──────────┘

💡 [재고 최적화 권장사항]
1. [긴급] 유산균 원액 A 발주
   - 현재고: 2.2일분 (안전재고 미달)
   - 리드타임: 5일
   - 권장 발주량: 1,000kg
   - 납기: 1/20 예상

2. [이번 주] 완제품 출하 촉진
   - △△ D2C 출하 협의 (85 Pallet)
   - 홈쇼핑 PB 선출하 가능 여부 확인

3. [월간] 장기 체류 재고 처리
   - 90일 이상 체류: 28 Pallet (3.2억원)
   - 유통기한 임박: 12 Pallet (1.5억원)
   - 할인 판매 또는 폐기 검토 필요

📈 [입출고 예정]
• 금주 입고 예정: 45 Pallet (원료 30, 포장재 15)
• 금주 출하 예정: 95 Pallet (완제품)
• 주말 예상 재고: 645 Pallet (64.5%)
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chart_type": "pie",
  "style": "donut_shadow",
  "title": "창고별 재고 비율",
  "subtitle": "2024-01-15 기준 (총 695 Pallet)",
  "innerRadius": 50,
  "data": [
    {
      "name": "완제품창고",
      "value": 245,
      "ratio": 35.3,
      "capacity": 300,
      "utilization": 81.7,
      "status": "warning",
      "color": "#FFC107"
    },
    {
      "name": "저온창고",
      "value": 198,
      "ratio": 28.5,
      "capacity": 300,
      "utilization": 66.0,
      "status": "normal",
      "color": "#4CAF50"
    },
    {
      "name": "원료창고",
      "value": 142,
      "ratio": 20.4,
      "capacity": 200,
      "utilization": 71.0,
      "status": "normal",
      "color": "#2196F3"
    },
    {
      "name": "포장재창고",
      "value": 98,
      "ratio": 14.1,
      "capacity": 150,
      "utilization": 65.3,
      "status": "normal",
      "color": "#9C27B0"
    },
    {
      "name": "격리창고",
      "value": 12,
      "ratio": 1.7,
      "capacity": 50,
      "utilization": 24.0,
      "status": "good",
      "color": "#607D8B"
    }
  ],
  "center_text": {
    "main": "695",
    "sub": "Pallet"
  },
  "inventory_value": {
    "total": 17.6,
    "unit": "억원",
    "by_type": {
      "FG": 8.5,
      "RM": 6.2,
      "PKG": 2.9
    }
  },
  "alerts": [
    {"warehouse": "완제품창고", "type": "space", "message": "가용률 81.7% 주의"},
    {"item": "유산균 원액 A", "type": "safety_stock", "message": "안전재고 미달"}
  ]
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. 창고별 현재 재고량과 용량 대비 가용률(%) 표시
2. 품목 유형별(완제품/원료/포장재) 재고 금액 분포 포함
3. 재고 회전율과 재고일수로 적정 재고 수준 판단
4. 안전재고 미달 품목은 별도 테이블로 강조
5. 창고 공간 부족 시 출하 예정 물량과 연계 분석
6. 입출고 예정으로 주간 재고 변동 예측 제공
7. 자재·물류팀 즉시 조치 가능한 구체적 권장사항
==============================================================
"""
    },

    "CCP_유형별": {
        "keywords": ["CCP", "유형별", "CCP현황", "중요관리점"],
        "chart": ChartConfig("pie", "도넛 스타일 + 그림자", "CCP 유형별 현황"),
        "data_source": "ccp_check_log + operation_mst (is_ccp='Y')",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - CCP 유형별 현황 분석 (HACCP)
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- CCP 유형별 점검 현황 집계
SELECT
    o.op_name as ccp_type,
    o.is_ccp,
    COUNT(*) as total_checks,
    COUNT(CASE WHEN c.result_flag = 'PASS' THEN 1 END) as pass_count,
    COUNT(CASE WHEN c.result_flag = 'FAIL' THEN 1 END) as fail_count,
    ROUND(COUNT(CASE WHEN c.result_flag = 'PASS' THEN 1 END) * 100.0 / COUNT(*), 2) as pass_rate
FROM ccp_check_log c
JOIN operation_mst o ON c.op_id = o.op_id
WHERE c.check_dt >= date('now', '-30 days')
  AND o.is_ccp = 'Y'
GROUP BY o.op_name, o.is_ccp
ORDER BY total_checks DESC;

-- CCP 이탈 상세 내역
SELECT
    o.op_name as ccp_type,
    c.check_dt,
    e.equip_name,
    l.line_name,
    c.check_value,
    c.lower_limit,
    c.upper_limit,
    c.action_taken,
    c.lot_id
FROM ccp_check_log c
JOIN operation_mst o ON c.op_id = o.op_id
JOIN equipment_mst e ON c.equip_id = e.equip_id
JOIN line_mst l ON e.line_id = l.line_id
WHERE c.check_dt >= date('now', '-7 days')
  AND c.result_flag = 'FAIL'
ORDER BY c.check_dt DESC;

-- 시간대별 CCP 이탈 패턴
SELECT
    strftime('%H', c.check_dt) as hour,
    o.op_name as ccp_type,
    COUNT(*) as fail_count
FROM ccp_check_log c
JOIN operation_mst o ON c.op_id = o.op_id
WHERE c.check_dt >= date('now', '-30 days')
  AND c.result_flag = 'FAIL'
GROUP BY strftime('%H', c.check_dt), o.op_name
ORDER BY hour;

-- CCP별 주간 트렌드
SELECT
    strftime('%Y-W%W', c.check_dt) as week,
    o.op_name as ccp_type,
    ROUND(COUNT(CASE WHEN c.result_flag = 'PASS' THEN 1 END) * 100.0 / COUNT(*), 2) as pass_rate
FROM ccp_check_log c
JOIN operation_mst o ON c.op_id = o.op_id
WHERE c.check_dt >= date('now', '-8 weeks')
  AND o.is_ccp = 'Y'
GROUP BY strftime('%Y-W%W', c.check_dt), o.op_name
ORDER BY week;
----------------------------------------------------------

[2. CCP(중요관리점) 관리 기준]
----------------------------------------------------------
| CCP No | CCP명 | 위해요소 | 한계기준 | 모니터링 방법 |
|--------|-------|----------|----------|---------------|
| CCP-1 | 살균온도 | 병원성 미생물 | 85~95℃, 30초 | 연속 자동측정 |
| CCP-2 | 금속검출 | 금속 이물질 | Fe 1.0mm, SUS 1.5mm | 제품 전수검사 |
| CCP-3 | 충진온도 | 미생물 증식 | 제품별 기준±2℃ | 배치당 측정 |

[HACCP 7원칙 적용]
1. 위해요소 분석 (HA): 생물학적/화학적/물리적 위해요소
2. 중요관리점 결정 (CCP): 살균, 금속검출, 충진온도
3. 한계기준 설정 (CL): 과학적 근거 기반 허용범위
4. 모니터링 방법 수립: 연속/주기적 점검
5. 개선조치 수립: 이탈 시 LOT 격리 및 재가공
6. 검증절차 수립: 정기 검교정 및 내부감사
7. 기록유지 관리: 전자문서 2년 보관
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[CCP별 합격률 목표]
- 살균온도 (CCP-1): 100% (이탈 시 즉시 격리)
- 금속검출 (CCP-2): 100% (이탈 시 재검사 + 격리)
- 충진온도 (CCP-3): 99.5% 이상

[합격률 상태 판정]
- 100%: ✅ 완벽 (GREEN) - HACCP 준수
- 99.5% ~ 100%: ✅ 정상 (GREEN)
- 99% ~ 99.5%: ⚠️ 주의 (YELLOW) - 개선 필요
- 99% 미만: 🚨 경고 (RED) - 긴급 조치

[이탈 심각도 분류]
- Critical: 식품안전 직접 위협 (미생물, 금속)
- Major: 품질 영향 가능성 높음
- Minor: 경미한 규격 이탈

[HACCP 문서화 요건]
- 모든 이탈 건 기록 필수
- 개선조치 24시간 내 문서화
- 월간 CCP 검토회의 실시
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
CCP 이상 감지 시 자동으로 다음을 추가 조회합니다:

1) CCP 이탈 발생 시:
   → 해당 LOT 전체 이력 추적 (원료→공정→완제품)
   → 동일 시간대 다른 CCP 상태 확인
   → 설비 알람 이력 조회 (alarm_event)
   → 이전 유사 이탈 패턴 검색

2) 특정 CCP 합격률 99% 미만 시:
   → 해당 CCP 설비별 이탈률 비교
   → 작업자/교대조별 이탈 패턴 분석
   → 원료 LOT별 상관관계 분석

3) 이탈 빈도 증가 시 (전주 대비 +50%):
   → 설비 PM 이력 확인
   → 환경 조건(온습도) 변화 분석
   → 공정 파라미터 변경 이력 조회
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
CCP 유형별 현황을 분석했습니다. (최근 30일)

🛡️ [CCP 유형별 점검 현황]
┌────────────┬──────────┬─────────┬─────────┬─────────┐
│ CCP        │ 점검건수 │ PASS    │ FAIL    │ 합격률  │
├────────────┼──────────┼─────────┼─────────┼─────────┤
│ 살균온도   │ 51,840   │ 51,835  │ 5       │ 99.99%  │
│ 금속검출   │ 1,456,000│1,455,992│ 8       │ 99.999% │
│ 충진온도   │ 2,880    │ 2,875   │ 5       │ 99.83%  │
├────────────┼──────────┼─────────┼─────────┼─────────┤
│ 합계       │1,510,720 │1,510,702│ 18      │ 99.999% │
└────────────┴──────────┴─────────┴─────────┴─────────┘

📊 [CCP별 점검 비율 분포]
• 금속검출: 96.4% (전수검사로 건수 최다)
• 살균온도: 3.4% (연속 모니터링)
• 충진온도: 0.2% (배치당 측정)

🚨 [CCP 이탈 내역 (최근 7일)]
┌──────────┬────────────┬───────────┬────────┬─────────────┐
│ 일시     │ CCP        │ 설비      │ 측정값 │ 조치        │
├──────────┼────────────┼───────────┼────────┼─────────────┤
│ 1/15 14:25│ 살균온도   │ UHT-02    │ 84.1℃ │ LOT 격리    │
│ 1/14 09:32│ 금속검출   │ MD-01     │ 검출   │ 재검사PASS  │
│ 1/13 16:48│ 충진온도   │ FILL-03   │ 68.2℃ │ LOT 격리    │
│ 1/12 11:15│ 살균온도   │ UHT-02    │ 83.8℃ │ 설비점검    │
│ 1/10 08:22│ 금속검출   │ MD-02     │ 검출   │ 재검사PASS  │
└──────────┴────────────┴───────────┴────────┴─────────────┘

📈 [주간 CCP 합격률 트렌드]
┌────────────┬─────────┬─────────┬─────────┬─────────┐
│ CCP        │ W01     │ W02     │ W03     │ W04     │
├────────────┼─────────┼─────────┼─────────┼─────────┤
│ 살균온도   │ 100.00% │ 99.99%  │ 99.99%  │ 99.98%  │
│ 금속검출   │ 100.00% │ 100.00% │ 99.999% │ 99.999% │
│ 충진온도   │ 99.90%  │ 99.85%  │ 99.80%  │ 99.83%  │
└────────────┴─────────┴─────────┴─────────┴─────────┘

🔍 [자동 분석 결과]
⚠️ 충진온도 CCP 주의 필요!

[패턴 분석]
• 충진온도 합격률: 99.83% (목표 99.5% 달성, 개선 여지)
• 이탈 집중 설비: FILL-03 (5건 중 3건 발생)
• 이탈 집중 시간: 오후 16:00~17:00 (라인정지 후 재가동)

[리스크 평가]
┌────────────┬───────────┬────────────┬─────────┐
│ CCP        │ 리스크    │ 빈도       │ 심각도  │
├────────────┼───────────┼────────────┼─────────┤
│ 살균온도   │ 중간      │ 월 2~3건   │ Critical│
│ 금속검출   │ 낮음      │ 월 3~4건   │ Critical│
│ 충진온도   │ 주의      │ 월 4~5건   │ Major   │
└────────────┴───────────┴────────────┴─────────┘

💡 [CCP 관리 강화 방안]
1. [긴급] UHT-02 정밀 점검
   - 최근 4건의 살균온도 이탈 발생
   - 온도센서 캘리브레이션 실시 (1/16 예정)
   - 스팀 밸브 상태 점검

2. [이번 주] FILL-03 충진온도 개선
   - 라인정지 후 재가동 시 온도 안정화 시간 연장 (5분→10분)
   - 충진온도 사전 확인 절차 추가

3. [월간] HACCP 내부 감사
   - CCP 모니터링 기록 검토
   - 개선조치 이행 확인
   - 검교정 일정 준수 확인

📋 [격리 LOT 현황]
• 현재 격리 중: 3 LOT (약 3,600병)
  - L240115-02: 살균온도 이탈 → 재살균 예정
  - L240113-18: 충진온도 이탈 → 품질검사 대기
  - L240114-05: 금속검출 → 재검사 PASS, 출하 가능
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chart_type": "pie",
  "style": "donut_shadow",
  "title": "CCP 유형별 점검 현황",
  "subtitle": "최근 30일 HACCP 모니터링 (총 1,510,720건)",
  "innerRadius": 55,
  "data": [
    {
      "name": "금속검출 (CCP-2)",
      "value": 1456000,
      "ratio": 96.4,
      "pass_rate": 99.999,
      "fail_count": 8,
      "status": "normal",
      "color": "#4CAF50",
      "severity": "critical"
    },
    {
      "name": "살균온도 (CCP-1)",
      "value": 51840,
      "ratio": 3.4,
      "pass_rate": 99.99,
      "fail_count": 5,
      "status": "normal",
      "color": "#2196F3",
      "severity": "critical"
    },
    {
      "name": "충진온도 (CCP-3)",
      "value": 2880,
      "ratio": 0.2,
      "pass_rate": 99.83,
      "fail_count": 5,
      "status": "warning",
      "color": "#FFC107",
      "severity": "major"
    }
  ],
  "center_text": {
    "main": "99.999%",
    "sub": "전체 합격률"
  },
  "trend": {
    "direction": "stable",
    "weeks": ["W01", "W02", "W03", "W04"],
    "ccp1": [100.00, 99.99, 99.99, 99.98],
    "ccp2": [100.00, 100.00, 99.999, 99.999],
    "ccp3": [99.90, 99.85, 99.80, 99.83]
  },
  "risk_matrix": {
    "CCP-1": {"risk": "medium", "frequency": "low", "severity": "critical"},
    "CCP-2": {"risk": "low", "frequency": "low", "severity": "critical"},
    "CCP-3": {"risk": "attention", "frequency": "medium", "severity": "major"}
  },
  "quarantine_lots": [
    {"lot_id": "L240115-02", "ccp": "CCP-1", "status": "재살균 예정"},
    {"lot_id": "L240113-18", "ccp": "CCP-3", "status": "품질검사 대기"},
    {"lot_id": "L240114-05", "ccp": "CCP-2", "status": "출하 가능"}
  ]
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. CCP별 점검건수, PASS/FAIL 건수, 합격률 모두 표시
2. 합격률은 소수점 3자리까지 표시 (99.999% 수준 구분)
3. 이탈 건별 구체적인 측정값, 설비, 조치내역 포함
4. 주간 트렌드로 CCP별 품질 변화 추이 분석
5. 리스크 평가 매트릭스 (빈도×심각도) 제공
6. 격리 LOT 현황 및 처리 상태 명시
7. HACCP 인증 유지를 위한 구체적 관리 방안 제안
8. QA팀이 즉시 조치할 수 있도록 우선순위 명확히 구분
==============================================================
"""
    },

    # ==================== GAUGE 차트 ====================
    "전체_가동률": {
        "keywords": ["가동률", "전체가동률", "OEE", "설비효율"],
        "chart": ChartConfig("gauge", "그라데이션 반원 게이지", "전체 설비종합효율(OEE)"),
        "data_source": "downtime_event + operation_exec + line_mst (OEE 3요소 계산)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 전체 설비종합효율(OEE) 분석
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- OEE 3요소 계산을 위한 기초 데이터 조회
-- 1) 가용률 계산: 계획시간 대비 실제 가동시간
SELECT
    l.line_id,
    l.line_name,
    8 * 60 as planned_min,  -- 1일 계획시간 (8시간)
    COALESCE(SUM(d.duration_min), 0) as downtime_min,
    ROUND((8*60 - COALESCE(SUM(d.duration_min), 0)) * 100.0 / (8*60), 2) as availability_rate
FROM line_mst l
LEFT JOIN downtime_event d ON l.line_id = d.line_id
    AND DATE(d.start_dt) = DATE('now')
WHERE l.line_id != 'PILOT'  -- Pilot 라인 제외
GROUP BY l.line_id, l.line_name;

-- 2) 성능률 계산: 이론생산량 대비 실제생산량
SELECT
    l.line_id,
    l.line_name,
    l.max_capacity as theoretical_capacity,
    SUM(o.qty_output) as actual_output,
    ROUND(SUM(o.qty_output) * 100.0 / l.max_capacity, 2) as performance_rate
FROM operation_exec o
JOIN mes_work_order m ON o.mes_order_id = m.mes_order_id
JOIN line_mst l ON m.line_id = l.line_id
WHERE DATE(o.end_dt) = DATE('now')
  AND l.line_id != 'PILOT'
GROUP BY l.line_id;

-- 3) 품질률 계산: 총생산 대비 양품률
SELECT
    l.line_id,
    l.line_name,
    SUM(o.qty_input) as total_input,
    SUM(o.qty_output) as good_output,
    SUM(o.scrap_qty) as defect_qty,
    ROUND(SUM(o.qty_output) * 100.0 / NULLIF(SUM(o.qty_input), 0), 2) as quality_rate
FROM operation_exec o
JOIN mes_work_order m ON o.mes_order_id = m.mes_order_id
JOIN line_mst l ON m.line_id = l.line_id
WHERE DATE(o.end_dt) = DATE('now')
  AND l.line_id != 'PILOT'
GROUP BY l.line_id;

-- OEE 6대 손실 분석 (연관 분석용)
SELECT
    CASE
        WHEN r.reason_category = 'BREAKDOWN' THEN '설비고장손실'
        WHEN r.reason_category = 'SETUP' THEN '작업준비/조정손실'
        WHEN r.reason_category = 'MINOR_STOP' THEN '잠깐정지손실'
        WHEN r.reason_category = 'SPEED' THEN '속도저하손실'
        WHEN r.reason_category = 'DEFECT' THEN '불량손실'
        WHEN r.reason_category = 'STARTUP' THEN '초기수율손실'
        ELSE '기타손실'
    END as loss_category,
    COUNT(*) as occurrence_count,
    SUM(d.duration_min) as total_loss_min
FROM downtime_event d
JOIN reason_code_mst r ON d.reason_code = r.reason_code
WHERE DATE(d.start_dt) = DATE('now')
GROUP BY r.reason_category
ORDER BY total_loss_min DESC;
----------------------------------------------------------

[2. OEE 계산 기준]
----------------------------------------------------------
| 구분 | 계산 공식 | 퓨어웰 목표 | 세계수준 |
|------|-----------|-------------|----------|
| OEE | 가용률 × 성능률 × 품질률 | 85% | 90% |
| 가용률 | (계획시간-비가동시간)/계획시간 | 90% | 95% |
| 성능률 | 실제생산량/이론생산량 | 95% | 98% |
| 품질률 | 양품수/총생산수 | 99% | 99.5% |

[6대 손실 구조]
┌─────────────────────────────────────────────────────────┐
│ 가용률 손실        │ 성능률 손실       │ 품질률 손실    │
├─────────────────────────────────────────────────────────┤
│ 1. 설비고장손실    │ 3. 잠깐정지손실   │ 5. 불량손실    │
│ 2. 작업준비/조정   │ 4. 속도저하손실   │ 6. 초기수율손실│
└─────────────────────────────────────────────────────────┘

[퓨어웰 설비 현황]
- 주요 생산라인: 3개 (1라인/2라인/3라인)
- 일일 최대 생산능력: 75,000병 (Pilot 제외)
- 계획가동시간: 8시간/일 (480분)
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[OEE 등급 기준]
- 90% 이상: 🏆 WORLD CLASS - 세계 최고 수준
- 85% ~ 90%: ✅ EXCELLENT - 목표 달성, 우수
- 75% ~ 85%: ⚠️ GOOD - 양호, 개선 여지 있음
- 65% ~ 75%: 🔶 AVERAGE - 평균, 개선 필요
- 65% 미만: 🚨 POOR - 심각한 개선 필요

[3요소별 최소 기준]
- 가용률 < 85%: ⚠️ 설비보전 점검 필요
- 성능률 < 90%: ⚠️ 라인밸런싱 점검 필요
- 품질률 < 97%: ⚠️ 품질관리 강화 필요

[손실 시간 경보 기준]
- 단일 고장 30분 초과: 🚨 긴급 대응 필요
- 일일 비가동 60분 초과: ⚠️ 원인 분석 필요
- 주간 누적 300분 초과: 📊 설비 점검 계획 수립
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
[OEE가 85% 미만일 경우]
→ 3요소 중 가장 낮은 항목 원인 분석
→ 해당 라인의 비가동 이력 상세 조회
→ 설비별 MTBF(평균고장간격) / MTTR(평균수리시간) 계산
→ 전일/전주 동일 시간대 OEE와 비교

[가용률이 병목일 경우]
→ 설비별 고장 빈도 및 유형 분석
→ 예방보전 일정 점검
→ 교체 필요 부품 예측

[성능률이 병목일 경우]
→ 라인별 사이클타임 분석
→ 잠깐정지(Choko-tei) 발생 패턴 분석
→ 작업자별 생산성 비교

[품질률이 병목일 경우]
→ 공정별 불량 유형 분석
→ 품질검사 결과와 연계 분석
→ 원자재 LOT별 품질 추적
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
📊 **전체 설비종합효율(OEE) 현황**

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         🎯 현재 OEE: **82.4%**
              목표: 85% | 달성률: 96.9%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📈 **OEE 3요소 분석**

| 구분 | 현재 | 목표 | 상태 | 손실시간 |
|------|------|------|------|----------|
| 가용률 | 91.2% | 90% | ✅ | 42분 |
| 성능률 | 93.5% | 95% | ⚠️ | 31분 |
| 품질률 | 96.7% | 99% | ⚠️ | 16분 |

🔍 **주요 손실 요인 (Top 3)**

1️⃣ **작업준비/조정손실** - 28분 (33%)
   - 제품 전환 시 CIP 세척 시간 증가
   - 1라인: 품목 변경 3회 (A-12 → B-07 → A-15)

2️⃣ **속도저하손실** - 23분 (27%)
   - 2라인 충진기 속도 85% 제한 운전 중
   - 원인: 캡핑 불량 빈발로 속도 다운

3️⃣ **불량손실** - 16분 (19%)
   - 3라인 충진량 편차로 인한 불량 38건
   - 품질률 96.7% → 목표 99% 미달

💡 **개선 권고사항**

⚡ **즉시 조치**
- 2라인 캡핑 설비 점검 및 조정 (속도 100% 복원)
- 3라인 충진 노즐 교정 (충진량 편차 ±1% 이내)

📋 **단기 개선 (금주 내)**
- 제품 전환 시 SMED 기법 적용 검토
- CIP 세척 공정 최적화 (현재 45분 → 목표 30분)

📊 **설비보전 권고**
- 2라인 충진기 PM 예정일: 12/15 → 금주 내 앞당김 검토
- 캡핑 헤드 교체 필요 (사용시간 2,400hr 경과)

⏰ 기준시점: 2024-12-08 14:30 | 다음 갱신: 15:00
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chartType": "gauge",
  "title": "전체 설비종합효율(OEE)",
  "config": {
    "style": "semicircle",
    "animation": true,
    "thickness": 25
  },
  "data": {
    "value": 82.4,
    "min": 0,
    "max": 100,
    "unit": "%"
  },
  "thresholds": [
    {"min": 0, "max": 65, "color": "#dc3545", "label": "POOR"},
    {"min": 65, "max": 75, "color": "#fd7e14", "label": "AVERAGE"},
    {"min": 75, "max": 85, "color": "#ffc107", "label": "GOOD"},
    {"min": 85, "max": 90, "color": "#28a745", "label": "EXCELLENT"},
    {"min": 90, "max": 100, "color": "#007bff", "label": "WORLD CLASS"}
  ],
  "target": {
    "value": 85,
    "label": "목표",
    "lineStyle": "dashed",
    "color": "#000"
  },
  "subGauges": [
    {
      "label": "가용률",
      "value": 91.2,
      "target": 90,
      "color": "#28a745"
    },
    {
      "label": "성능률",
      "value": 93.5,
      "target": 95,
      "color": "#ffc107"
    },
    {
      "label": "품질률",
      "value": 96.7,
      "target": 99,
      "color": "#ffc107"
    }
  ],
  "lossBreakdown": {
    "title": "손실 구성",
    "items": [
      {"category": "작업준비/조정", "minutes": 28, "percentage": 33},
      {"category": "속도저하", "minutes": 23, "percentage": 27},
      {"category": "불량", "minutes": 16, "percentage": 19},
      {"category": "설비고장", "minutes": 12, "percentage": 14},
      {"category": "기타", "minutes": 6, "percentage": 7}
    ]
  },
  "trendIndicator": {
    "direction": "up",
    "change": 1.8,
    "period": "전일 대비"
  }
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. OEE 수치는 소수점 1자리까지 표시
2. 3요소 모두 분석하여 병목 요소 명확히 지적
3. 6대 손실 구조에 따라 손실 원인 분류
4. 설비보전팀/생산팀/품질팀 각각의 조치사항 구분
5. 구체적인 설비명과 손실 시간 명시
6. MTBF/MTTR 트렌드 언급하여 예방보전 시사점 제공
7. 목표 OEE 달성을 위한 우선순위 제안
----------------------------------------------------------
"""
    },

    "CCP_합격률": {
        "keywords": ["CCP", "합격률", "CCP합격", "CCP합격률", "HACCP"],
        "chart": ChartConfig("gauge", "위험도 표시 게이지", "CCP 합격률 (HACCP 핵심관리)"),
        "data_source": "ccp_check_log + ccp_master (중요관리점 검사 합격률)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - CCP 합격률 분석 (HACCP 인증 핵심지표)
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 금일 CCP 검사 합격률 산출
SELECT
    COUNT(*) as total_checks,
    SUM(CASE WHEN result_flag = 'PASS' THEN 1 ELSE 0 END) as pass_count,
    SUM(CASE WHEN result_flag = 'FAIL' THEN 1 ELSE 0 END) as fail_count,
    ROUND(SUM(CASE WHEN result_flag = 'PASS' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as pass_rate
FROM ccp_check_log
WHERE DATE(check_dt) = DATE('now');

-- CCP 유형별 합격률 상세
SELECT
    c.ccp_id,
    c.ccp_name,
    c.hazard_type,
    c.control_measure,
    c.critical_limit_min,
    c.critical_limit_max,
    c.unit,
    COUNT(l.check_id) as check_count,
    SUM(CASE WHEN l.result_flag = 'PASS' THEN 1 ELSE 0 END) as pass_count,
    SUM(CASE WHEN l.result_flag = 'FAIL' THEN 1 ELSE 0 END) as fail_count,
    ROUND(AVG(l.measured_value), 2) as avg_measured,
    MIN(l.measured_value) as min_measured,
    MAX(l.measured_value) as max_measured,
    ROUND(SUM(CASE WHEN l.result_flag = 'PASS' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as pass_rate
FROM ccp_master c
LEFT JOIN ccp_check_log l ON c.ccp_id = l.ccp_id
    AND DATE(l.check_dt) = DATE('now')
GROUP BY c.ccp_id, c.ccp_name, c.hazard_type
ORDER BY pass_rate ASC;

-- CCP 이탈(FAIL) 상세 내역
SELECT
    l.check_id,
    l.ccp_id,
    c.ccp_name,
    c.hazard_type,
    l.lot_no,
    l.measured_value,
    c.critical_limit_min,
    c.critical_limit_max,
    c.unit,
    l.check_dt,
    l.checker_id,
    l.corrective_action,
    l.disposition
FROM ccp_check_log l
JOIN ccp_master c ON l.ccp_id = c.ccp_id
WHERE DATE(l.check_dt) = DATE('now')
  AND l.result_flag = 'FAIL'
ORDER BY l.check_dt DESC;

-- 이탈 LOT 격리/조치 현황 (연관 분석용)
SELECT
    l.lot_no,
    i.item_name,
    l.disposition,
    l.corrective_action,
    CASE l.disposition
        WHEN 'QUARANTINE' THEN '격리 대기'
        WHEN 'RETEST' THEN '재검사 진행'
        WHEN 'RELEASE' THEN '출하 승인'
        WHEN 'REJECT' THEN '폐기 처리'
    END as disposition_status,
    l.check_dt
FROM ccp_check_log l
JOIN mes_work_order m ON l.lot_no = m.lot_no
JOIN item_mst i ON m.item_id = i.item_id
WHERE DATE(l.check_dt) = DATE('now')
  AND l.result_flag = 'FAIL';
----------------------------------------------------------

[2. CCP 관리 기준 (퓨어웰 음료)]
----------------------------------------------------------
| CCP ID | 관리점명 | 위해요소 | 관리한계 | 모니터링 주기 |
|--------|----------|----------|----------|---------------|
| CCP-01 | 살균 온도 | 생물학적(병원균) | 85~95°C | 연속 모니터링 |
| CCP-02 | 살균 시간 | 생물학적(병원균) | ≥15초 | 연속 모니터링 |
| CCP-03 | 냉각 온도 | 생물학적(증식) | ≤10°C (30분 내) | 30분 |
| CCP-04 | 금속검출 | 물리적(금속이물) | Fe ≤1.5mm, Sus ≤2.0mm | 전수 검사 |
| CCP-05 | pH 관리 | 화학적(변질) | 3.0~4.5 | 배치당 |

[HACCP 7원칙 기준 관리]
1️⃣ 위해요소 분석 → 생물학적/화학적/물리적 위해요소 식별
2️⃣ CCP 결정 → 5개 핵심관리점 설정
3️⃣ 한계기준 설정 → 과학적 근거 기반 설정
4️⃣ 모니터링 체계 → 연속/주기적 측정
5️⃣ 개선조치 → 이탈 시 즉시 대응
6️⃣ 검증절차 → 정기 검증 및 유효성 평가
7️⃣ 기록관리 → 모든 검사 기록 보관

[인증 유지 조건]
- CCP 합격률: 100% 필수 (HACCP 인증 유지 조건)
- 이탈 발생 시: 즉시 격리 → 원인분석 → 시정조치 → 재발방지
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[합격률 기준 - HACCP 필수 관리]
- 100%: ✅ 정상 - HACCP 인증 적합
- 99% ~ 99.9%: ⚠️ 주의 - 이탈 발생, 즉시 조치 완료 필요
- 98% ~ 99%: 🔶 경고 - 반복 이탈, 근본원인 분석 필요
- 98% 미만: 🚨 심각 - HACCP 인증 위험, 긴급 점검 필요

[이탈 대응 단계]
1. 즉시 조치 (5분 내)
   - 해당 LOT 격리
   - 생산 일시 중단 (해당 CCP)
   - QA 담당자 알림

2. 원인 분석 (30분 내)
   - 측정 장비 점검
   - 공정 조건 확인
   - 원자재 상태 점검

3. 시정 조치 (2시간 내)
   - 근본원인 제거
   - 격리 LOT 처리 결정 (재검사/폐기)
   - 유사 LOT 확대 검사

4. 재발 방지 (24시간 내)
   - 시정조치 보고서 작성
   - 예방조치 계획 수립
   - 모니터링 강화

[위해요소별 위험도]
- 생물학적 위해(살균): 🚨 최고위험 - 식중독 직결
- 물리적 위해(금속): 🔶 고위험 - 소비자 상해 가능
- 화학적 위해(pH): ⚠️ 중위험 - 변질/부패 가능
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
[이탈 발생 시 자동 분석]
→ 동일 LOT의 모든 CCP 검사 결과 조회
→ 해당 라인의 최근 7일 이탈 이력 조회
→ 동일 CCP의 측정값 트렌드 분석 (관리한계 접근 감지)
→ 관련 원자재 LOT 품질 이력 조회

[살균 온도 이탈 시]
→ 살균기 온도 센서 로그 상세 조회
→ 스팀 압력/유량 데이터 확인
→ 해당 시간대 보일러 상태 점검
→ 살균 시간 동시 점검

[금속검출 이탈 시]
→ 금속검출기 감도 테스트 기록 조회
→ 이전 공정 설비 마모 상태 점검
→ 원자재 입고 검사 금속 이력 조회
→ 검출 금속 유형 분석 (Fe/Sus/Non-Fe)

[pH 이탈 시]
→ 원자재 배합 비율 점검
→ 발효 공정 데이터 조회 (유산균 음료)
→ 저장 온도 이력 확인
→ 유통기한 영향 분석
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
🛡️ **CCP 합격률 현황** (HACCP 핵심관리지표)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         ✅ 현재 합격률: **99.7%**
         목표: 100% | 금일 검사: 342건
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 **CCP별 검사 현황**

| CCP | 관리점 | 검사 | 합격 | 이탈 | 합격률 | 상태 |
|-----|--------|------|------|------|--------|------|
| CCP-01 | 살균온도 | 96 | 96 | 0 | 100% | ✅ |
| CCP-02 | 살균시간 | 96 | 96 | 0 | 100% | ✅ |
| CCP-03 | 냉각온도 | 48 | 48 | 0 | 100% | ✅ |
| CCP-04 | 금속검출 | 54 | 54 | 0 | 100% | ✅ |
| CCP-05 | pH관리 | 48 | 47 | 1 | 97.9% | ⚠️ |

🚨 **이탈 발생 내역** (금일 1건)

| 시간 | CCP | LOT번호 | 측정값 | 한계기준 | 조치상태 |
|------|-----|---------|--------|----------|----------|
| 10:35 | CCP-05 | L241208-003 | 4.62 | 3.0~4.5 | 🔄 격리중 |

📋 **이탈 상세 분석**

**LOT: L241208-003** (2라인 / 유기농 발효음료)
- 📍 CCP-05 (pH 관리) 이탈
- 📏 측정값: **4.62** (상한 초과 +0.12)
- ⏰ 발생시점: 10:35 / 발견자: 김품질
- 🏭 해당 배치: 1,200병 생산 완료

**원인 분석**
- 발효 시간 초과 (표준 24hr → 실제 26hr)
- 2라인 발효탱크 온도 +1.5°C 상승 확인
- 유산균 활성도 상승으로 pH 추가 저하

**조치 현황**
- ✅ 10:38 - 해당 LOT 격리 완료
- ✅ 10:45 - 생산 일시 중단
- 🔄 11:00 - 재검사 진행 중 (3회 측정)
- ⏳ 11:30 - 처리 결정 예정

💡 **권고 조치**

⚡ **즉시 조치**
- 재검사 결과 기준 내 진입 시 → 조건부 출하 검토
- 기준 초과 유지 시 → 제품 폐기 결정

📋 **재발 방지**
- 발효 시간 모니터링 알람 설정 (24hr ± 30min)
- 2라인 발효탱크 온도센서 교정 (금주 내)
- 발효 담당자 재교육 실시

📊 **HACCP 기록 자동 생성**
- 시정조치 보고서 #CA-2024-089 자동 생성됨
- 담당: QA팀 / 승인대기: 품질관리 책임자

⏰ 기준시점: 2024-12-08 11:15 | HACCP 일일 마감: 18:00
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chartType": "gauge",
  "title": "CCP 합격률 (HACCP)",
  "config": {
    "style": "speedometer",
    "animation": true,
    "showNeedle": true,
    "dangerZoneHighlight": true
  },
  "data": {
    "value": 99.7,
    "min": 95,
    "max": 100,
    "unit": "%"
  },
  "thresholds": [
    {"min": 95, "max": 98, "color": "#dc3545", "label": "심각"},
    {"min": 98, "max": 99, "color": "#fd7e14", "label": "경고"},
    {"min": 99, "max": 99.9, "color": "#ffc107", "label": "주의"},
    {"min": 99.9, "max": 100, "color": "#28a745", "label": "정상"}
  ],
  "target": {
    "value": 100,
    "label": "HACCP 필수",
    "lineStyle": "solid",
    "color": "#28a745"
  },
  "alerts": [
    {
      "type": "deviation",
      "severity": "warning",
      "ccp": "CCP-05",
      "lot": "L241208-003",
      "message": "pH 상한 초과 (4.62)",
      "status": "격리중"
    }
  ],
  "ccpBreakdown": [
    {"ccp": "CCP-01", "name": "살균온도", "passRate": 100, "checks": 96, "status": "normal"},
    {"ccp": "CCP-02", "name": "살균시간", "passRate": 100, "checks": 96, "status": "normal"},
    {"ccp": "CCP-03", "name": "냉각온도", "passRate": 100, "checks": 48, "status": "normal"},
    {"ccp": "CCP-04", "name": "금속검출", "passRate": 100, "checks": 54, "status": "normal"},
    {"ccp": "CCP-05", "name": "pH관리", "passRate": 97.9, "checks": 48, "status": "warning"}
  ],
  "haccpStatus": {
    "certificationValid": true,
    "lastAudit": "2024-11-15",
    "nextAudit": "2025-02-15",
    "deviationsThisMonth": 3,
    "correctiveActionsOpen": 1
  },
  "trendIndicator": {
    "direction": "down",
    "change": 0.3,
    "period": "전일 대비"
  }
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. CCP 합격률 100%가 HACCP 인증 필수 조건임을 명시
2. 이탈 발생 시 해당 LOT 번호와 제품명 반드시 표시
3. 이탈 원인과 조치 상태를 단계별로 명확히 표시
4. 위해요소 유형(생물학적/물리적/화학적)별 위험도 안내
5. 시정조치 보고서 번호 및 담당자 정보 포함
6. HACCP 7원칙에 따른 체계적 대응 가이드 제공
7. 격리 LOT의 최종 처리 결정(출하/폐기) 상태 추적
8. 유사 이탈 재발 방지를 위한 예방조치 권고
----------------------------------------------------------
"""
    },

    "평균_불량률": {
        "keywords": ["불량률", "평균불량률", "불량", "스크랩", "수율"],
        "chart": ChartConfig("gauge", "역방향 게이지 (낮을수록 좋음)", "평균 불량률 현황"),
        "data_source": "operation_exec + qc_test + defect_mst (불량 유형별 분석)",
        "template": """
==============================================================
퓨어웰 음료 AI Agent - 평균 불량률 분석 (품질 핵심지표)
==============================================================

[1. 데이터 조회 SQL]
----------------------------------------------------------
-- 금일 전체 평균 불량률 산출
SELECT
    SUM(qty_input) as total_input,
    SUM(qty_output) as total_output,
    SUM(scrap_qty) as total_scrap,
    ROUND(SUM(scrap_qty) * 100.0 / NULLIF(SUM(qty_input), 0), 3) as defect_rate,
    ROUND(SUM(qty_output) * 100.0 / NULLIF(SUM(qty_input), 0), 2) as yield_rate
FROM operation_exec
WHERE DATE(end_dt) = DATE('now')
  AND result_flag IN ('PASS', 'PARTIAL');

-- 라인별 불량률 상세
SELECT
    l.line_id,
    l.line_name,
    l.line_type,
    SUM(o.qty_input) as input_qty,
    SUM(o.qty_output) as output_qty,
    SUM(o.scrap_qty) as scrap_qty,
    ROUND(SUM(o.scrap_qty) * 100.0 / NULLIF(SUM(o.qty_input), 0), 3) as defect_rate,
    COUNT(DISTINCT o.mes_order_id) as batch_count
FROM operation_exec o
JOIN mes_work_order m ON o.mes_order_id = m.mes_order_id
JOIN line_mst l ON m.line_id = l.line_id
WHERE DATE(o.end_dt) = DATE('now')
GROUP BY l.line_id, l.line_name, l.line_type
ORDER BY defect_rate DESC;

-- 공정별 불량률 분석
SELECT
    o.operation_type,
    CASE o.operation_type
        WHEN 'MIXING' THEN '배합'
        WHEN 'FERMENT' THEN '발효'
        WHEN 'PASTEUR' THEN '살균'
        WHEN 'FILL' THEN '충진'
        WHEN 'PACK' THEN '포장'
        ELSE o.operation_type
    END as operation_name,
    SUM(o.qty_input) as input_qty,
    SUM(o.scrap_qty) as scrap_qty,
    ROUND(SUM(o.scrap_qty) * 100.0 / NULLIF(SUM(o.qty_input), 0), 3) as defect_rate
FROM operation_exec o
WHERE DATE(o.end_dt) = DATE('now')
GROUP BY o.operation_type
ORDER BY defect_rate DESC;

-- 불량 유형별 분석 (품질검사 기준)
SELECT
    d.defect_code,
    d.defect_name,
    d.defect_category,
    d.severity,
    COUNT(q.test_id) as occurrence_count,
    SUM(q.fail_qty) as total_fail_qty
FROM qc_test q
JOIN defect_mst d ON q.defect_code = d.defect_code
WHERE DATE(q.test_dt) = DATE('now')
  AND q.result_flag = 'FAIL'
GROUP BY d.defect_code, d.defect_name, d.defect_category, d.severity
ORDER BY total_fail_qty DESC
LIMIT 10;

-- 시간대별 불량률 추이 (연관 분석용)
SELECT
    strftime('%H', o.end_dt) as hour,
    SUM(o.qty_input) as input_qty,
    SUM(o.scrap_qty) as scrap_qty,
    ROUND(SUM(o.scrap_qty) * 100.0 / NULLIF(SUM(o.qty_input), 0), 3) as defect_rate
FROM operation_exec o
WHERE DATE(o.end_dt) = DATE('now')
GROUP BY strftime('%H', o.end_dt)
ORDER BY hour;

-- 주간 불량률 트렌드 (연관 분석용)
SELECT
    DATE(end_dt) as work_date,
    ROUND(SUM(scrap_qty) * 100.0 / NULLIF(SUM(qty_input), 0), 3) as defect_rate
FROM operation_exec
WHERE DATE(end_dt) >= DATE('now', '-7 days')
GROUP BY DATE(end_dt)
ORDER BY work_date;
----------------------------------------------------------

[2. 불량 유형 분류 체계 (퓨어웰)]
----------------------------------------------------------
| 분류 | 코드 | 불량유형 | 발생공정 | 심각도 |
|------|------|----------|----------|--------|
| 공정불량 | DEF-01 | 배합비율 이상 | 배합 | 중 |
| 공정불량 | DEF-02 | 발효도 미달/과다 | 발효 | 상 |
| 공정불량 | DEF-03 | 살균온도 미달 | 살균 | 최상 |
| 충진불량 | DEF-11 | 충진량 과부족 | 충진 | 중 |
| 충진불량 | DEF-12 | 캡핑 불량 | 충진 | 상 |
| 충진불량 | DEF-13 | 라벨 불량 | 충진 | 하 |
| 포장불량 | DEF-21 | 박스 파손 | 포장 | 하 |
| 포장불량 | DEF-22 | 수량 오차 | 포장 | 중 |
| 이물불량 | DEF-31 | 이물 혼입 | 전공정 | 최상 |
| 외관불량 | DEF-41 | 용기 변형/파손 | 전공정 | 중 |

[불량률 산출 공식]
불량률(%) = (스크랩 수량 / 투입 수량) × 100
수율(%) = (양품 수량 / 투입 수량) × 100
PPM = 불량률 × 10,000

[퓨어웰 품질 목표]
- 목표 불량률: 2.0% 이하 (수율 98% 이상)
- 현재 고객 클레임률: 0.08%
- 목표 PPM: 200 이하
----------------------------------------------------------

[3. 판단 기준 (Threshold)]
----------------------------------------------------------
[불량률 등급 기준 - 낮을수록 좋음]
- 1.0% 이하: 🏆 EXCELLENT - 탁월한 품질 수준
- 1.0% ~ 1.5%: ✅ GOOD - 목표 초과 달성
- 1.5% ~ 2.0%: ⚠️ NORMAL - 목표 내, 개선 여지
- 2.0% ~ 3.0%: 🔶 WARNING - 목표 초과, 원인분석 필요
- 3.0% 초과: 🚨 CRITICAL - 긴급 품질회의 소집

[공정별 허용 불량률]
| 공정 | 허용기준 | 경고기준 | 위험기준 |
|------|----------|----------|----------|
| 배합 | 0.5% | 1.0% | 1.5% |
| 발효 | 1.0% | 1.5% | 2.0% |
| 살균 | 0.3% | 0.5% | 1.0% |
| 충진 | 1.5% | 2.0% | 3.0% |
| 포장 | 0.5% | 1.0% | 1.5% |

[불량 심각도별 대응]
- 최상(살균/이물): 🚨 즉시 라인 정지, 전수 검사
- 상(발효/캡핑): ⚠️ 해당 LOT 격리, 원인분석
- 중(충진량/배합): 🔶 모니터링 강화, 조정
- 하(라벨/박스): ℹ️ 기록 후 계속 생산
----------------------------------------------------------

[4. 연관 분석 자동 수행]
----------------------------------------------------------
[불량률 2% 초과 시]
→ 불량 TOP 3 유형 상세 분석
→ 해당 라인/공정 최근 7일 불량 추이
→ 동일 제품의 과거 불량 패턴 조회
→ 원자재 LOT별 불량 연관성 분석

[특정 공정 불량률 급증 시]
→ 설비 상태 및 최근 PM 이력 조회
→ 작업자별 불량 발생률 비교
→ 원자재 변경 이력 확인
→ 환경 조건(온도/습도) 변화 점검

[충진 불량 집중 발생 시]
→ 충진기 노즐별 편차 분석
→ 캡핑 토크 설정값 점검
→ 라벨러 센서 정렬 상태 확인
→ 용기 공급 불량 연관성 점검

[이물 불량 발생 시]
→ 해당 LOT 전수 재검사 지시
→ 이물 유형 분석 (금속/플라스틱/섬유)
→ 발생 공정 추적 (원자재/설비/환경)
→ 설비 청소 기록 및 점검 일지 확인
----------------------------------------------------------

[5. 응답 형식 예시]
----------------------------------------------------------
📊 **평균 불량률 현황** (품질 핵심지표)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         ⚠️ 현재 불량률: **1.87%**
         목표: 2.0% | 수율: 98.13%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📈 **라인별 불량률 현황**

| 라인 | 투입량 | 양품 | 불량 | 불량률 | 상태 |
|------|--------|------|------|--------|------|
| 1라인 | 15,200 | 14,950 | 250 | 1.64% | ✅ |
| 2라인 | 19,800 | 19,380 | 420 | 2.12% | 🔶 |
| 3라인 | 17,500 | 17,220 | 280 | 1.60% | ✅ |
| Pilot | 2,800 | 2,690 | 110 | 3.93% | 🚨 |
| **합계** | **55,300** | **54,240** | **1,060** | **1.92%** | ⚠️ |

🔍 **공정별 불량 분석**

| 공정 | 불량수 | 비율 | 허용기준 | 상태 |
|------|--------|------|----------|------|
| 충진 | 580 | 54.7% | 1.5% | 🔶 |
| 포장 | 210 | 19.8% | 0.5% | ⚠️ |
| 발효 | 150 | 14.2% | 1.0% | ✅ |
| 배합 | 80 | 7.5% | 0.5% | ✅ |
| 살균 | 40 | 3.8% | 0.3% | ✅ |

🚨 **불량 유형 TOP 5**

| 순위 | 불량유형 | 건수 | 수량 | 주요 원인 |
|------|----------|------|------|-----------|
| 1 | 충진량 과부족 | 42 | 320 | 노즐 막힘/마모 |
| 2 | 캡핑 불량 | 28 | 180 | 토크 설정 편차 |
| 3 | 라벨 틀어짐 | 15 | 150 | 센서 정렬 불량 |
| 4 | 발효도 과다 | 8 | 120 | 온도 관리 미흡 |
| 5 | 박스 파손 | 12 | 80 | 포장라인 충격 |

⚠️ **주의 필요 항목**

🔶 **2라인 불량률 상승** (1.85% → 2.12%)
- 10시~12시 충진 불량 집중 발생 (68%)
- 원인: 2-A 충진기 3번 노즐 충진량 +5% 편차
- 조치: 노즐 교정 완료 (12:30), 모니터링 중

🚨 **Pilot 라인 불량률 급증** (2.8% → 3.93%)
- 신제품 테스트 중 발효도 조절 어려움
- 원인: 신규 유산균 배양 최적 조건 미확정
- 조치: R&D팀 공정조건 재검토 진행 중

💡 **개선 권고사항**

⚡ **즉시 조치**
- 2라인 충진기 전체 노즐 점검 (17:00 생산 종료 후)
- Pilot 라인 발효 조건 표준화 미팅 (R&D/생산/QC)

📋 **단기 개선 (금주 내)**
- 충진 불량 감소를 위한 노즐 교체 주기 단축 (3개월 → 2개월)
- 캡핑 토크 자동 보정 시스템 도입 검토

📊 **품질회의 안건**
- 2라인 충진 공정 FMEA 재검토
- Pilot 라인 신제품 공정 안정화 일정 협의

⏰ 기준시점: 2024-12-08 15:00 | 일일 마감 집계: 18:00
----------------------------------------------------------

[6. 차트 렌더링 데이터 (JSON)]
----------------------------------------------------------
{
  "chartType": "gauge",
  "title": "평균 불량률",
  "config": {
    "style": "invertedGauge",
    "animation": true,
    "lowerIsBetter": true,
    "showYieldRate": true
  },
  "data": {
    "value": 1.87,
    "min": 0,
    "max": 5,
    "unit": "%",
    "yieldRate": 98.13
  },
  "thresholds": [
    {"min": 0, "max": 1.0, "color": "#007bff", "label": "EXCELLENT"},
    {"min": 1.0, "max": 1.5, "color": "#28a745", "label": "GOOD"},
    {"min": 1.5, "max": 2.0, "color": "#ffc107", "label": "NORMAL"},
    {"min": 2.0, "max": 3.0, "color": "#fd7e14", "label": "WARNING"},
    {"min": 3.0, "max": 5.0, "color": "#dc3545", "label": "CRITICAL"}
  ],
  "target": {
    "value": 2.0,
    "label": "목표 상한",
    "lineStyle": "dashed",
    "color": "#dc3545"
  },
  "lineBreakdown": [
    {"line": "1라인", "defectRate": 1.64, "status": "good", "trend": "stable"},
    {"line": "2라인", "defectRate": 2.12, "status": "warning", "trend": "up"},
    {"line": "3라인", "defectRate": 1.60, "status": "good", "trend": "down"},
    {"line": "Pilot", "defectRate": 3.93, "status": "critical", "trend": "up"}
  ],
  "processBreakdown": [
    {"process": "충진", "defects": 580, "percentage": 54.7},
    {"process": "포장", "defects": 210, "percentage": 19.8},
    {"process": "발효", "defects": 150, "percentage": 14.2},
    {"process": "배합", "defects": 80, "percentage": 7.5},
    {"process": "살균", "defects": 40, "percentage": 3.8}
  ],
  "defectTypes": [
    {"type": "충진량 과부족", "count": 320, "severity": "medium"},
    {"type": "캡핑 불량", "count": 180, "severity": "high"},
    {"type": "라벨 틀어짐", "count": 150, "severity": "low"},
    {"type": "발효도 과다", "count": 120, "severity": "high"},
    {"type": "박스 파손", "count": 80, "severity": "low"}
  ],
  "weeklyTrend": [
    {"date": "12-02", "defectRate": 1.65},
    {"date": "12-03", "defectRate": 1.72},
    {"date": "12-04", "defectRate": 1.58},
    {"date": "12-05", "defectRate": 1.81},
    {"date": "12-06", "defectRate": 1.95},
    {"date": "12-07", "defectRate": 1.78},
    {"date": "12-08", "defectRate": 1.87}
  ],
  "trendIndicator": {
    "direction": "up",
    "change": 0.09,
    "period": "전일 대비"
  }
}
----------------------------------------------------------

[7. 응답 규칙]
----------------------------------------------------------
1. 불량률은 "낮을수록 좋음"을 명확히 표시
2. 라인별/공정별/유형별 다각도 분석 제공
3. 불량률 상승 라인/공정은 원인과 함께 경고 표시
4. 불량 유형별 심각도와 권장 대응 수준 안내
5. 수율(양품률)을 함께 표시하여 긍정적 지표 제공
6. 시간대별/일별 트렌드로 악화/개선 추이 파악
7. 불량 집중 공정에 대한 구체적 개선안 제시
8. 품질회의 안건으로 활용 가능한 요약 정보 포함
----------------------------------------------------------
"""
    },
}


class PromptRouter:
    """프롬프트 라우터 - 간단한 질문을 확장된 프롬프트로 변환"""

    def __init__(self):
        self.templates = PROMPT_TEMPLATES

    def find_matching_template(self, query: str) -> Optional[str]:
        """
        입력 질문에서 키워드를 매칭하여 템플릿 키를 반환
        """
        query_lower = query.lower().replace(" ", "")

        best_match = None
        best_score = 0

        for template_key, template_data in self.templates.items():
            keywords = template_data["keywords"]
            score = 0

            for keyword in keywords:
                if keyword in query or keyword in query_lower:
                    score += 1

            if score > best_score:
                best_score = score
                best_match = template_key

        return best_match if best_score > 0 else None

    def route(self, query: str) -> Optional[PromptRoute]:
        """
        질문을 라우팅하여 확장된 프롬프트 반환
        """
        template_key = self.find_matching_template(query)

        if not template_key:
            return None

        template_data = self.templates[template_key]

        return PromptRoute(
            keywords=template_data["keywords"],
            chart_config=template_data["chart"],
            data_source=template_data["data_source"],
            expanded_prompt=template_data["template"].strip()
        )

    def get_final_prompt(self, query: str) -> str:
        """
        최종 프롬프트 생성 (원본 질문 + 확장 프롬프트)
        """
        route_result = self.route(query)

        if not route_result:
            return f"""
[사용자 질문]
{query}

[안내]
죄송합니다. 해당 질문에 대한 템플릿을 찾지 못했습니다.
다음과 같은 질문을 시도해보세요:
- "라인별 생산량 보여줘"
- "월별 매출 현황"
- "CCP 합격률"
- "전체 가동률 보여줘"
"""

        final_prompt = f"""
[사용자 질문]
{query}

[차트 설정]
- 유형: {route_result.chart_config.chart_type}
- 스타일: {route_result.chart_config.style}
- 제목: {route_result.chart_config.title}

[데이터 소스]
{route_result.data_source}

{route_result.expanded_prompt}
"""
        return final_prompt.strip()


# ============================================
# 테스트 실행
# ============================================

if __name__ == "__main__":
    import sys
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

    router = PromptRouter()

    # 테스트 질문들
    test_queries = [
        "라인별 생산량 보여줘",
        "월별 매출 현황",
        "설비별 비가동 시간 분석",
        "월별 생산량 추이 보여줘",
        "매출 트렌드 분석",
        "온도 변화 추이",
        "품질검사 결과 분포",
        "창고별 재고 비율",
        "CCP 유형별 현황",
        "전체 가동률 보여줘",
        "CCP 합격률",
        "평균 불량률 현황",
    ]

    print("=" * 60)
    print("퓨어웰 음료 AI Agent - 프롬프트 라우터 테스트")
    print("=" * 60)

    for query in test_queries:
        print(f"\n{'-' * 60}")
        print(f"[질문] {query}")
        print(f"{'-' * 60}")

        result = router.route(query)

        if result:
            print(f"[O] 매칭된 키워드: {result.keywords}")
            print(f"[차트] {result.chart_config.chart_type} ({result.chart_config.style})")
            print(f"[데이터] {result.data_source}")
            print(f"\n[확장된 프롬프트 미리보기 - 첫 200자]")
            print(result.expanded_prompt[:200] + "...")
        else:
            print("[X] 매칭되는 템플릿 없음")

    # 실제 최종 프롬프트 예시 출력
    print("\n" + "=" * 60)
    print("[최종 프롬프트 예시]")
    print("=" * 60)

    sample_query = "라인별 생산량 보여줘"
    final_prompt = router.get_final_prompt(sample_query)
    print(final_prompt)
