# MES/ERP RAG 기능 테스트 가이드

## 🔥 최신 수정 내용 (2025-11-19)

### Backend 개선 (mes_data_service.rs)
1. **쿼리 전처리 로직 추가**
   - 숫자 자동 추출: "90도" → "90"
   - 키워드 매핑: "온도", "습도", "진동", "압력" 인식
   - NG/OK 용어 자동 변환

2. **3단계 검색 전략**
   - 1차: FTS5 BM25 검색 (개선된 검색어)
   - 2차: LIKE 패턴 매칭 (FTS5 실패시)
   - 3차: 전체 데이터 샘플링 (모든 검색 실패시)

3. **LLM 호출 보장**
   - 검색 결과가 없어도 전체 데이터로 답변 생성
   - "찾지 못했습니다" 메시지 제거

### Frontend 개선 (ChatInterface.tsx)
- MES RAG가 데이터를 찾지 못하면 자동으로 일반 Chat LLM 호출
- 콘솔 로그로 fallback 상황 추적 가능

## 📋 테스트 준비

### 1. 샘플 데이터
- **파일**: `sample_mes_data.csv`
- **내용**: 3개 설비(EQ-001, EQ-002, EQ-003)의 온도/습도/진동/판정 데이터
- **데이터 특징**:
  - 온도 범위: 75°C ~ 95°C
  - NG 판정 조건: 온도 ≥ 90°C 또는 진동 ≥ 4.0
  - 총 12개 데이터 포인트

### 2. 애플리케이션 실행
```bash
cd c:\dev\Judgify-core
npm run tauri dev
```

## 🧪 테스트 시나리오

### Step 1: CSV 파일 업로드

1. **Chat 탭** 열기
2. **Paperclip 아이콘** 클릭
3. `sample_mes_data.csv` 파일 선택
4. 업로드 완료 확인 (12건 업로드 메시지)

**기대 결과**:
```
✅ 파일 업로드 완료: sample_mes_data.csv (12 행)
```

### Step 2: 자연어 질의응답 테스트

다음 질문들을 순서대로 테스트하세요:

#### 테스트 1: 온도 조건 검색
**질문**: "온도가 90도 이상인 데이터는?"

**기대 답변**:
- EQ-001: 92°C (10:00, NG)
- EQ-002: 95°C (10:00, NG), 93°C (12:00, NG)
- EQ-003: 90°C (09:00, NG), 91°C (11:00, NG)

#### 테스트 2: 설비별 분석
**질문**: "EQ-002 설비의 상태는 어때?"

**기대 답변**:
- 정상(OK): 2건 (09:00, 11:00)
- 불량(NG): 2건 (10:00, 12:00)
- 온도 범위: 75°C ~ 95°C
- 불량 원인: 높은 온도 및 진동

#### 테스트 3: 시간대별 분석
**질문**: "10시에 불량이 발생한 설비는?"

**기대 답변**:
- EQ-001: 92°C, 진동 3.8
- EQ-002: 95°C, 진동 4.5

#### 테스트 4: 판정 통계
**질문**: "전체 데이터에서 NG 판정 비율은?"

**기대 답변**:
- 총 12건 중 NG 5건 (41.7%)
- OK 7건 (58.3%)

#### 테스트 5: 복합 조건
**질문**: "진동이 4.0 이상이면서 온도가 90도 이상인 경우는?"

**기대 답변**:
- EQ-002: 95°C, 진동 4.5 (10:00)
- EQ-002: 93°C, 진동 4.2 (12:00)
- EQ-003: 91°C, 진동 4.0 (11:00)

## 🔍 검증 포인트

### 백엔드 검증
Rust 콘솔에서 다음 로그 확인:

```
[MES RAG] ✅ 파일 업로드 완료: sample_mes_data.csv (12 행)
[MES RAG] 🔍 검색 결과: X 행
[MES RAG] ✅ LLM 답변 생성 완료
```

### 프론트엔드 검증
1. ✅ 파일 업로드 진행률 표시
2. ✅ 업로드 완료 Toast 알림
3. ✅ 세션 정보 표시 (파일명, 행 수, 업로드 시각)
4. ✅ 질문에 대한 실시간 답변 표시
5. ✅ 채팅 히스토리 저장

### 데이터베이스 검증
SQLite 데이터베이스에 저장된 데이터 확인:

```sql
-- 업로드된 데이터 확인
SELECT COUNT(*) FROM mes_data_logs;
-- 기대값: 12

-- FTS5 인덱스 확인
SELECT COUNT(*) FROM mes_data_logs_fts;
-- 기대값: 12

-- 샘플 데이터 조회
SELECT file_name, row_index, content
FROM mes_data_logs
LIMIT 3;
```

## ✅ 성공 기준

- [ ] CSV 파일이 정상적으로 업로드됨 (12건)
- [ ] 자연어 질문에 대한 답변이 정확함
- [ ] BM25 검색 결과가 관련도 높은 순으로 정렬됨
- [ ] LLM이 검색 결과를 기반으로 답변 생성
- [ ] 세션별 데이터 격리 정상 작동
- [ ] UI에서 업로드 상태 및 결과 표시

## 🐛 문제 해결

### 업로드 실패시
1. 콘솔에서 오류 메시지 확인
2. CSV 파일 인코딩 확인 (UTF-8)
3. 데이터베이스 파일 권한 확인

### 답변 없음
1. Claude API 키 설정 확인
2. 네트워크 연결 확인
3. Rust 콘솔에서 LLM 호출 로그 확인

### 검색 결과 없음
1. FTS5 인덱스 생성 확인
2. 검색 키워드가 데이터에 포함되어 있는지 확인
3. 세션 ID가 올바른지 확인

## 📊 성능 측정

- **업로드 시간**: 12건 < 1초
- **검색 시간**: BM25 검색 < 50ms
- **LLM 응답**: Claude API 응답 < 3초
- **총 응답 시간**: 질문 → 답변 < 5초

## 🎯 다음 단계

테스트 완료 후:
1. ✅ Todo 리스트 업데이트
2. ✅ TASKS.md에 실측 성능 데이터 기록
3. ✅ Git 커밋 및 푸시
4. 📝 사용자 문서 작성 (선택)
5. 🚀 Phase 9 진행 (선택)
