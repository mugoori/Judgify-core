name: Version Consistency Check

on:
  push:
    branches: [develop, main]
  pull_request:

jobs:
  check-versions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check version consistency across all files
        run: |
          echo "üîç Checking version consistency..."
          echo "=========================================="

          # Extract versions from each file
          VERSION_PY=$(grep '__version__ = ' version.py | cut -d'"' -f2)
          PACKAGE_JSON=$(jq -r '.version' package.json)
          CARGO_TOML=$(grep '^version = ' src-tauri/Cargo.toml | head -1 | cut -d'"' -f2)
          TAURI_CONF=$(jq -r '.package.version' src-tauri/tauri.conf.json)

          # Display current versions
          echo "üì¶ Current versions:"
          echo "   version.py:        $VERSION_PY"
          echo "   package.json:      $PACKAGE_JSON"
          echo "   Cargo.toml:        $CARGO_TOML"
          echo "   tauri.conf.json:   $TAURI_CONF"
          echo "=========================================="

          # Check if all versions match
          if [ "$VERSION_PY" != "$PACKAGE_JSON" ] || \
             [ "$VERSION_PY" != "$CARGO_TOML" ] || \
             [ "$VERSION_PY" != "$TAURI_CONF" ]; then
            echo "‚ùå ERROR: Version mismatch detected!"
            echo ""
            echo "üõ†Ô∏è  How to fix:"
            echo "   1. DO NOT manually edit version files"
            echo "   2. Run: python scripts/bump_version.py patch"
            echo "   3. Commit all 4 files together"
            echo ""
            echo "üìã Files that must be synced:"
            echo "   - version.py"
            echo "   - package.json"
            echo "   - src-tauri/Cargo.toml"
            echo "   - src-tauri/tauri.conf.json"
            echo ""
            echo "‚ö†Ô∏è  Special note: tauri.conf.json is critical!"
            echo "   Tauri updater reads version from this file."
            echo "   Version mismatch will cause \"update required\" errors."
            echo ""
            exit 1
          fi

          echo "‚úÖ All versions are in sync: $VERSION_PY"
          echo "üéâ Version consistency check passed!"

      - name: Validate version format (SemVer)
        run: |
          VERSION=$(grep '__version__' version.py | cut -d'"' -f2)

          # Check SemVer format (0.x.x for initial development)
          if ! echo "$VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$' > /dev/null; then
            echo "‚ùå ERROR: Invalid version format: $VERSION"
            echo "Expected SemVer format: 0.MINOR.PATCH (e.g., 0.3.1)"
            exit 1
          fi

          echo "‚úÖ Version format is valid: $VERSION"
