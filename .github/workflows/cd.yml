# Judgify-core v2.0 Continuous Deployment Pipeline
# ì§€ì†ì  ë°°í¬ íŒŒì´í”„ë¼ì¸ - í™˜ê²½ë³„ ìë™ ë°°í¬

name: CD Pipeline

on:
  # CI íŒŒì´í”„ë¼ì¸ ì„±ê³µ í›„ ì‹¤í–‰
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main, develop]
  
  # ìˆ˜ë™ ë°°í¬ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force_deploy:
        description: 'Force deployment (skip checks)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io
  IMAGE_NAME: judgify/judgify-core

# ë™ì‹œ ë°°í¬ ë°©ì§€
concurrency:
  group: deployment-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ë°°í¬ ì¤€ë¹„ ë° ê²€ì¦
  deployment-preparation:
    name: Deployment Preparation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      deploy-approval: ${{ steps.check-approval.outputs.approved }}
      image-tag: ${{ steps.generate-tag.outputs.tag }}
    
    steps:
    - name: Check CI Pipeline Status
      if: github.event_name == 'workflow_run'
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
          echo "âŒ CI Pipeline failed. Stopping deployment."
          exit 1
        fi
        echo "âœ… CI Pipeline passed. Proceeding with deployment."
    
    - name: Determine Target Environment
      id: determine-env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "environment=production" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
          echo "environment=staging" >> $GITHUB_OUTPUT
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
        fi
    
    - name: Check Deployment Approval
      id: check-approval
      run: |
        env="${{ steps.determine-env.outputs.environment }}"
        force="${{ github.event.inputs.force_deploy }}"
        
        if [ "$env" = "production" ] && [ "$force" != "true" ]; then
          echo "approved=false" >> $GITHUB_OUTPUT
          echo "âš ï¸  Production deployment requires manual approval"
        else
          echo "approved=true" >> $GITHUB_OUTPUT
          echo "âœ… Deployment approved for $env environment"
        fi
    
    - name: Generate Image Tag
      id: generate-tag
      run: |
        if [ "${{ steps.determine-env.outputs.environment }}" = "production" ]; then
          tag="v2.0.0-${GITHUB_SHA::8}"
        else
          tag="${{ steps.determine-env.outputs.environment }}-${GITHUB_SHA::8}"
        fi
        echo "tag=$tag" >> $GITHUB_OUTPUT
        echo "Generated image tag: $tag"

  # ìˆ˜ë™ ìŠ¹ì¸ (ìš´ì˜í™˜ê²½ë§Œ)
  production-approval:
    name: Production Deployment Approval
    runs-on: ubuntu-latest
    needs: [deployment-preparation]
    if: needs.deployment-preparation.outputs.environment == 'production' && needs.deployment-preparation.outputs.deploy-approval == 'false'
    environment: production-approval
    
    steps:
    - name: Manual Approval Required
      run: |
        echo "ğŸš€ Production deployment approval requested"
        echo "Environment: ${{ needs.deployment-preparation.outputs.environment }}"
        echo "Image Tag: ${{ needs.deployment-preparation.outputs.image-tag }}"
        echo "Commit: ${{ github.sha }}"

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: [deployment-preparation]
    if: needs.deployment-preparation.outputs.deploy-approval == 'true' || needs.deployment-preparation.outputs.environment != 'production'
    
    strategy:
      matrix:
        service: [api-gateway, workflow, judgment, action, logging, dashboard]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}
        tags: |
          type=raw,value=${{ needs.deployment-preparation.outputs.image-tag }}
          type=raw,value=latest,enable=${{ needs.deployment-preparation.outputs.environment == 'production' }}
    
    - name: Build and push base image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/base/Dockerfile.python
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-base:${{ needs.deployment-preparation.outputs.image-tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push service image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: services/${{ matrix.service }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          BASE_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-base:${{ needs.deployment-preparation.outputs.image-tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [deployment-preparation, build-and-push]
    if: needs.deployment-preparation.outputs.environment == 'staging'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Set up Kubernetes context
      run: |
        # kubectl ì»¨í…ìŠ¤íŠ¸ ì„¤ì • (ì‹¤ì œ í´ëŸ¬ìŠ¤í„° ì •ë³´ë¡œ êµì²´ í•„ìš”)
        echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
        kubectl config current-context
    
    - name: Deploy to staging
      env:
        NAMESPACE: judgify-staging
        IMAGE_TAG: ${{ needs.deployment-preparation.outputs.image-tag }}
        ENVIRONMENT: staging
      run: |
        # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± (ì—†ëŠ” ê²½ìš°)
        kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
        
        # ì‹œí¬ë¦¿ ì ìš©
        kubectl apply -f k8s/secrets/ -n $NAMESPACE
        
        # ConfigMap ì ìš©
        kubectl apply -f k8s/configmaps/ -n $NAMESPACE
        
        # ì„œë¹„ìŠ¤ ë°°í¬ (ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸)
        for service in api-gateway workflow judgment action logging dashboard; do
          if [ -f "k8s/services/${service}-service.yaml" ]; then
            envsubst < k8s/services/${service}-service.yaml | kubectl apply -f - -n $NAMESPACE
          fi
        done
        
        # ë°°í¬ ìƒíƒœ í™•ì¸
        kubectl rollout status deployment -n $NAMESPACE --timeout=300s
    
    - name: Run smoke tests
      env:
        STAGING_URL: https://staging-api.judgify.ai
      run: |
        # ê¸°ë³¸ í—¬ìŠ¤ì²´í¬
        curl -f "$STAGING_URL/health" || exit 1
        
        # API í…ŒìŠ¤íŠ¸
        if [ -f "tests/smoke/smoke_tests.py" ]; then
          python tests/smoke/smoke_tests.py --base-url "$STAGING_URL"
        fi
    
    - name: Notify deployment success
      if: success()
      run: |
        echo "âœ… Staging deployment completed successfully"
        echo "Environment: staging"
        echo "Image Tag: ${{ needs.deployment-preparation.outputs.image-tag }}"
        echo "URL: https://staging-api.judgify.ai"

  # ìš´ì˜ í™˜ê²½ ë°°í¬
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deployment-preparation, build-and-push, production-approval]
    if: needs.deployment-preparation.outputs.environment == 'production' && (always() && !failure() && !cancelled())
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Set up Kubernetes context
      run: |
        # kubectl ì»¨í…ìŠ¤íŠ¸ ì„¤ì • (ì‹¤ì œ ìš´ì˜ í´ëŸ¬ìŠ¤í„° ì •ë³´ë¡œ êµì²´ í•„ìš”)
        echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config
        kubectl config current-context
    
    - name: Pre-deployment backup
      env:
        NAMESPACE: judgify-prod
      run: |
        # í˜„ì¬ ë°°í¬ëœ ì´ë¯¸ì§€ ì •ë³´ ë°±ì—…
        kubectl get deployments -n $NAMESPACE -o yaml > /tmp/pre-deployment-backup.yaml
        
        # ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… (ì‹¤ì œ ë°±ì—… ëª…ë ¹ìœ¼ë¡œ êµì²´ í•„ìš”)
        echo "ğŸ“¦ Database backup initiated"
    
    - name: Deploy to production (Blue-Green)
      env:
        NAMESPACE: judgify-prod
        IMAGE_TAG: ${{ needs.deployment-preparation.outputs.image-tag }}
        ENVIRONMENT: production
      run: |
        # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
        kubectl get namespace $NAMESPACE
        
        # ì‹œí¬ë¦¿ í™•ì¸ (ìš´ì˜í™˜ê²½ ì‹œí¬ë¦¿ì€ ìˆ˜ë™ìœ¼ë¡œ ë¯¸ë¦¬ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨)
        kubectl get secrets -n $NAMESPACE
        
        # ConfigMap ì ìš©
        kubectl apply -f k8s/configmaps/ -n $NAMESPACE
        
        # Blue-Green ë°°í¬ ì‹œì‘
        echo "ğŸ”„ Starting Blue-Green deployment..."
        
        for service in api-gateway workflow judgment action logging dashboard; do
          if [ -f "k8s/services/${service}-service.yaml" ]; then
            # ìƒˆ ë²„ì „ ë°°í¬ (Green)
            envsubst < k8s/services/${service}-service.yaml | \
              sed "s/${service}-service/${service}-service-green/g" | \
              kubectl apply -f - -n $NAMESPACE
            
            # Green ë²„ì „ Ready ëŒ€ê¸°
            kubectl rollout status deployment ${service}-service-green -n $NAMESPACE --timeout=300s
          fi
        done
        
        echo "âœ… Green deployment completed"
    
    - name: Production smoke tests
      env:
        PROD_URL: https://api.judgify.ai
        GREEN_URL: https://green.api.judgify.ai  # Green í™˜ê²½ í…ŒìŠ¤íŠ¸ URL
      run: |
        # Green í™˜ê²½ í…ŒìŠ¤íŠ¸
        curl -f "$GREEN_URL/health" || exit 1
        
        # ìƒì„¸ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
        if [ -f "tests/smoke/production_smoke_tests.py" ]; then
          python tests/smoke/production_smoke_tests.py --base-url "$GREEN_URL"
        fi
        
        echo "âœ… Production smoke tests passed"
    
    - name: Switch traffic (Blue to Green)
      env:
        NAMESPACE: judgify-prod
      run: |
        echo "ğŸ”„ Switching traffic from Blue to Green..."
        
        for service in api-gateway workflow judgment action logging dashboard; do
          # ì„œë¹„ìŠ¤ ì…€ë ‰í„°ë¥¼ Greenìœ¼ë¡œ ë³€ê²½
          kubectl patch service ${service}-service -n $NAMESPACE \
            -p '{"spec":{"selector":{"version":"green"}}}'
        done
        
        # íŠ¸ë˜í”½ ì „í™˜ ê²€ì¦
        sleep 30
        curl -f "https://api.judgify.ai/health" || exit 1
        
        echo "âœ… Traffic switched to Green successfully"
    
    - name: Cleanup Blue deployment
      env:
        NAMESPACE: judgify-prod
      run: |
        echo "ğŸ§¹ Cleaning up Blue deployment..."
        
        for service in api-gateway workflow judgment action logging dashboard; do
          kubectl delete deployment ${service}-service -n $NAMESPACE --ignore-not-found=true
          kubectl delete service ${service}-service-blue -n $NAMESPACE --ignore-not-found=true
        done
        
        # Greenì„ ìƒˆë¡œìš´ Blueë¡œ rename
        for service in api-gateway workflow judgment action logging dashboard; do
          kubectl patch deployment ${service}-service-green -n $NAMESPACE \
            --type='merge' -p='{"metadata":{"name":"'${service}'-service"}}'
        done
        
        echo "âœ… Blue-Green deployment completed"
    
    - name: Post-deployment verification
      env:
        PROD_URL: https://api.judgify.ai
      run: |
        # ìš´ì˜ í™˜ê²½ ìµœì¢… ê²€ì¦
        echo "ğŸ” Running post-deployment verification..."
        
        # í—¬ìŠ¤ì²´í¬
        curl -f "$PROD_URL/health" || exit 1
        
        # í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        if [ -f "tests/smoke/critical_path_tests.py" ]; then
          python tests/smoke/critical_path_tests.py --base-url "$PROD_URL"
        fi
        
        echo "âœ… Post-deployment verification passed"

  # ë°°í¬ ê²°ê³¼ ì•Œë¦¼
  deployment-notification:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deployment-preparation, deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: Determine deployment result
      id: result
      run: |
        environment="${{ needs.deployment-preparation.outputs.environment }}"
        
        if [ "$environment" = "staging" ]; then
          if [ "${{ needs.deploy-staging.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… Staging deployment successful" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Staging deployment failed" >> $GITHUB_OUTPUT
          fi
        else
          if [ "${{ needs.deploy-production.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… Production deployment successful" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Production deployment failed" >> $GITHUB_OUTPUT
          fi
        fi
    
    - name: Notify Slack
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "${{ steps.result.outputs.message }}",
              "attachments": [
                {
                  "color": "${{ steps.result.outputs.status == 'success' && 'good' || 'danger' }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "${{ needs.deployment-preparation.outputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "Image Tag",
                      "value": "${{ needs.deployment-preparation.outputs.image-tag }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "${{ github.sha }}",
                      "short": true
                    },
                    {
                      "title": "Deployer",
                      "value": "${{ github.actor }}",
                      "short": true
                    }
                  ]
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL
        fi
    
    - name: Create deployment summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ needs.deployment-preparation.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ steps.result.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: ${{ needs.deployment-preparation.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.result.outputs.status }}" = "success" ]; then
          echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Deployment failed. Please check logs and retry.**" >> $GITHUB_STEP_SUMMARY
        fi

  # ë¡¤ë°± ì›Œí¬í”Œë¡œìš° (ì‹¤íŒ¨ì‹œ ìˆ˜ë™ íŠ¸ë¦¬ê±°)
  rollback-preparation:
    name: Rollback Preparation
    runs-on: ubuntu-latest
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    needs: [deployment-preparation, deploy-staging, deploy-production]
    
    steps:
    - name: Prepare rollback information
      run: |
        echo "## âš ï¸ Deployment Failed - Rollback Required" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "A rollback may be necessary. Please:" >> $GITHUB_STEP_SUMMARY
        echo "1. Check deployment logs for error details" >> $GITHUB_STEP_SUMMARY
        echo "2. Run manual rollback if needed: \`kubectl rollout undo deployment <service-name>\`" >> $GITHUB_STEP_SUMMARY
        echo "3. Verify service health after rollback" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: ${{ needs.deployment-preparation.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Failed Image Tag**: ${{ needs.deployment-preparation.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY