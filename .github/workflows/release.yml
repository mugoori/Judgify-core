name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v2.0.0)'
        required: true
        type: string

env:
  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          release_name: TriFlow AI ${{ steps.get_version.outputs.VERSION }}
          body: |
            TriFlow AI Desktop Application Release

            ## 주요 변경사항
            - System Tray 통합 (백그라운드 실행)
            - Auto Update 기능
            - Visual Workflow Builder
            - Dashboard & Settings 페이지

            ## 설치 방법
            1. Windows: `.msi` 또는 `.exe` 파일 다운로드
            2. 설치 프로그램 실행
            3. 앱 시작 후 Claude API 키 설정

            ## 업데이트 방법
            - Settings 페이지에서 "업데이트 확인" 클릭
            - 또는 자동 업데이트 알림 확인
          draft: false
          prerelease: false

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]
        include:
          - platform: windows-latest
            rust_target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Clean Rust build cache
        run: |
          cd src-tauri
          cargo clean
        shell: bash

      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'TriFlow AI ${{ github.ref_name }}'
          releaseBody: 'See the release notes above.'
          releaseDraft: false
          prerelease: false
          projectPath: .
          args: --target ${{ matrix.rust_target }}

  generate-update-manifest:
    needs: [create-release, build-tauri]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download release assets
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: '${{ steps.get_version.outputs.VERSION }}'
            });

            const assets = release.assets;
            const msiAsset = assets.find(a => a.name.endsWith('.msi.zip'));
            const sigAsset = assets.find(a => a.name.endsWith('.msi.zip.sig'));

            if (!msiAsset || !sigAsset) {
              core.setFailed('MSI or signature file not found');
              return;
            }

            // Download signature file content
            const https = require('https');
            const sigResponse = await new Promise((resolve, reject) => {
              https.get(sigAsset.browser_download_url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(data));
              }).on('error', reject);
            });

            const manifest = {
              version: '${{ steps.get_version.outputs.VERSION }}'.replace('v', ''),
              notes: 'TriFlow AI Desktop Application 업데이트',
              pub_date: new Date().toISOString(),
              platforms: {
                'windows-x86_64': {
                  signature: sigResponse.trim(),
                  url: msiAsset.browser_download_url
                }
              }
            };

            fs.writeFileSync('latest.json', JSON.stringify(manifest, null, 2));

      - name: Delete existing latest.json (if exists)
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: '${{ steps.get_version.outputs.VERSION }}'
            });

            const existingAsset = release.assets.find(a => a.name === 'latest.json');
            if (existingAsset) {
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: existingAsset.id
              });
              console.log('Deleted existing latest.json');
            }

      - name: Upload update manifest
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./latest.json
          asset_name: latest.json
          asset_content_type: application/json

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'chore: Update latest.json for ${{ steps.get_version.outputs.VERSION }}'
