#!/bin/bash
# Git Pre-Commit Hook: 브랜치 백업 자동 알림
# 설치: cp scripts/git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# 색상 정의
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# 백업 권장 임계값
CRITICAL_FILES=(
    "CLAUDE.md"
    "initial.md"
    "system-structure.md"
    "docs/architecture/system_overview.md"
    "docs/development/plan.md"
)
LINE_THRESHOLD=200
ARCHITECTURE_FILES_THRESHOLD=3

# 변경된 파일 목록
CHANGED_FILES=$(git diff --cached --name-only)

# 백업 권장 플래그
BACKUP_RECOMMENDED=false
REASONS=()

# 1. CLAUDE.md 200줄 이상 변경 체크
if echo "$CHANGED_FILES" | grep -q "CLAUDE.md"; then
    CLAUDE_CHANGES=$(git diff --cached CLAUDE.md | grep -E "^\+|^\-" | wc -l)
    if [ "$CLAUDE_CHANGES" -ge "$LINE_THRESHOLD" ]; then
        BACKUP_RECOMMENDED=true
        REASONS+=("📄 CLAUDE.md ${CLAUDE_CHANGES}줄 변경 (임계값: ${LINE_THRESHOLD}줄)")
    fi
fi

# 2. 핵심 컨텍스트 파일 변경 체크
for file in "${CRITICAL_FILES[@]}"; do
    if echo "$CHANGED_FILES" | grep -q "$file"; then
        FILE_CHANGES=$(git diff --cached "$file" | grep -E "^\+|^\-" | wc -l)
        if [ "$FILE_CHANGES" -ge 50 ]; then
            BACKUP_RECOMMENDED=true
            REASONS+=("📄 $file ${FILE_CHANGES}줄 변경 (중요 파일)")
        fi
    fi
done

# 3. 아키텍처 파일 다수 변경 체크
ARCHITECTURE_CHANGES=$(echo "$CHANGED_FILES" | grep -c "docs/architecture/" || true)
if [ "$ARCHITECTURE_CHANGES" -ge "$ARCHITECTURE_FILES_THRESHOLD" ]; then
    BACKUP_RECOMMENDED=true
    REASONS+=("🏗️  아키텍처 파일 ${ARCHITECTURE_CHANGES}개 변경 (임계값: ${ARCHITECTURE_FILES_THRESHOLD}개)")
fi

# 4. 서비스 파일 다수 변경 체크
SERVICE_CHANGES=$(echo "$CHANGED_FILES" | grep -c "docs/services/" || true)
if [ "$SERVICE_CHANGES" -ge 3 ]; then
    BACKUP_RECOMMENDED=true
    REASONS+=("⚙️  서비스 설계 파일 ${SERVICE_CHANGES}개 변경 (임계값: 3개)")
fi

# 5. package.json, requirements.txt 등 의존성 변경 체크
if echo "$CHANGED_FILES" | grep -qE "package\.json|requirements\.txt|Cargo\.toml|go\.mod"; then
    DEPENDENCY_FILES=$(echo "$CHANGED_FILES" | grep -E "package\.json|requirements\.txt|Cargo\.toml|go\.mod" || true)
    BACKUP_RECOMMENDED=true
    REASONS+=("📦 의존성 파일 변경: $(echo $DEPENDENCY_FILES | tr '\n' ', ')")
fi

# 6. Docker/Kubernetes 설정 변경 체크
if echo "$CHANGED_FILES" | grep -qE "Dockerfile|docker-compose|k8s/|\.yaml$|\.yml$"; then
    INFRA_FILES=$(echo "$CHANGED_FILES" | grep -E "Dockerfile|docker-compose|k8s/|\.yaml$|\.yml$" | wc -l)
    if [ "$INFRA_FILES" -ge 2 ]; then
        BACKUP_RECOMMENDED=true
        REASONS+=("🐳 인프라 설정 파일 ${INFRA_FILES}개 변경")
    fi
fi

# 백업 권장 알림 출력
if [ "$BACKUP_RECOMMENDED" = true ]; then
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${YELLOW}⚠️  브랜치 백업 권장!${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${RED}다음 사유로 인해 브랜치 백업을 권장합니다:${NC}"
    for reason in "${REASONS[@]}"; do
        echo -e "  ${RED}•${NC} $reason"
    done
    echo ""
    echo -e "${GREEN}권장 워크플로우:${NC}"
    echo -e "  1. 현재 커밋 취소: ${YELLOW}git reset HEAD~${NC}"
    echo -e "  2. 현재 상태 커밋 (백업): ${YELLOW}git add . && git commit -m 'backup: 변경 전 상태'${NC}"
    echo -e "  3. 백업 브랜치 생성: ${YELLOW}git checkout -b {category}/{description}${NC}"
    echo -e "     예: ${YELLOW}git checkout -b docs/claude-md-major-update${NC}"
    echo -e "  4. 변경 작업 수행 및 커밋"
    echo -e "  5. 비교 보고서 작성 (템플릿: ${YELLOW}docs/templates/COMPARISON_TEMPLATE.md${NC})"
    echo ""
    echo -e "${GREEN}상세 가이드:${NC} docs/development/git-branch-strategy.md"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # 사용자 확인
    read -p "백업 없이 계속 진행하시겠습니까? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}커밋이 취소되었습니다. 백업 브랜치를 생성한 후 다시 커밋하세요.${NC}"
        exit 1
    fi

    echo -e "${YELLOW}⚠️  백업 없이 진행합니다. 나중에 롤백이 어려울 수 있습니다.${NC}"
    echo ""
fi

# 정상 진행
exit 0
